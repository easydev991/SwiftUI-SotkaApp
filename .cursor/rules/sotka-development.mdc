---
description: Правила разработки для проекта SwiftUI-SotkaApp
alwaysApply: true
---

# Правила разработки SotkaApp

## ДОКУМЕНТАЦИЯ ПРОЕКТА

### Основная документация

- **[README.md](../../README.md)** - основная информация о проекте, краткое описание функционала и ссылки на детальную документацию
- **[docs/](../../docs/)** - папка с детальной документацией проекта

## КРАТКИЕ ПРАВИЛА ДЛЯ CURSOR

### Технологический стек

- Минимальная версия iOS 17.0
- Swift 6.0 + SwiftUI + SwiftData + Observation
- OSLog для логирования
- TipKit для подсказок
- SWDesignSystem, SWNetwork, SWUtils, SWKeychain

### Архитектурные принципы

- MVVM с @Observable ViewModels
- Модульная структура (Screens, Services, Models, Libraries)
- Environment для dependency injection
- SwiftData для хранения данных

### Правила кодирования

- **View без параметров**: computed properties с суффиксом `View` (например: `var emptyStateView: some View`)
- **View с параметрами**: функции с префиксом `make` (например: `makeIconButton(for: type) -> some View`)
- **Computed properties для View**: без `make`, с суффиксом `View` (например: `var headerView: some View`)
- **@ViewBuilder**: использовать только при условной логике (`if/else`) или множественных view, НЕ для простых контейнеров (VStack, HStack)
- ViewModels: @Observable + название + ViewModel
- Сервисы: название + Service/Manager
- Один файл = один компонент
- OSLog вместо TODO комментариев
- Запускать `make format` после любых изменений в коде

## Общая архитектура

### Структура проекта

```
SwiftUI-SotkaApp/
├── Screens/           # Все экраны приложения
├── Services/          # Бизнес-логика и сервисы
├── Models/            # Модели данных
├── Libraries/         # Внутренние библиотеки
├── Extensions/        # Расширения
├── PreviewContent/    # Данные для превью в SwiftUI
└── SupportingFiles/   # Ресурсы и конфигурация
```

### Архитектурные паттерны

#### ViewModels

```swift
@Observable
final class SomeViewModel {
    // Состояние
    var isLoading = false
    var error: Error?
    
    // Зависимости через конструктор
    private let service: SomeService
    
    init(service: SomeService) {
        self.service = service
    }
    
    // Методы
    func loadData() async {
        // Реализация с использованием service
    }
}
```

#### Сервисы

```swift
// Пример с классом, когда нужно хранить и изменять какое-то внутреннее состояние
final class SomeService {
    // Реализация сервиса
}

// Пример со структурой, когда не нужно изменять состояния внутри сервиса
struct SomeService {
    // Реализация сервиса
}
```

#### Модели данных для хранения в Swift Data

```swift
@Model
final class SomeModel {
    // Свойства модели
}
```

## Сетевое взаимодействие

### Архитектура серверной интеграции

- **Протоколы клиентов** в `Services/Protocols/` — определяют интерфейсы для работы с API
- **SWClient** — единая точка входа для всех API запросов, реализует все протоколы клиентов
- **Сервисы** (например, `CustomExercisesService`) — бизнес-логика, используют клиенты для запросов к серверу
- **Модели ответов** (например, `CustomExerciseResponse`) — структуры для десериализации JSON ответов сервера
- **SwiftData модели** (например, `CustomExercise`) — модели для локального хранения с инициализаторами из ответов сервера

### Правила серверной интеграции

- Все новые API endpoints добавляются в `SWClient` через extension с соответствующим протоколом
- Протоколы клиентов создаются в `Services/Protocols/`
- Модели ответов сервера создаются в `Models/` с суффиксом `Response`
- Сервисы используют протоколы клиентов, а не конкретные реализации
- Все серверные операции логируются через `OSLog`

## Управление состоянием

### Глобальное состояние

- **AppSettings** - настройки приложения
- **AuthHelper** - авторизация
- **StatusManager** - статус тренировок
- **Environment** для передачи зависимостей

### Локальное состояние

- **@State** для простого состояния
- **@Observable** для сложного состояния
- **@Environment** для зависимостей

## UI/UX принципы

### Дизайн-система

- **SWDesignSystem** - пример дизайн-системы
- **Консистентные цвета и шрифты**
- **Адаптивность** для разных размеров экранов
- **Accessibility** поддержка

### Навигация

- **TabView** для основных разделов
- **NavigationStack** для детальных экранов
- **Модальные окна** для форм
- **Алерты** для подтверждений

## Работа с данными

### Офлайн-приоритет

- **См. отдельный файл**: `.cursor/rules/offline-priority.mdc` — подробные правила офлайн-работы и синхронизации
- **Критически важно**: приложение должно работать полностью офлайн, синхронизация - опциональна

### SWSharedModels

- В `Models/SWSharedModels/` размещаем общие модели, которые используются в SotkaApp (пакет `SWModels` или основной таргет).
- Остальные модели размещаем в `Models/` и группируем по смыслу/домену (например, `Models/Workout/`).

### SwiftData

- **@Model** для сущностей
- **ModelContainer** для контекста
- **@Query** для запросов данных
- **Миграции** при изменении схемы

### Кэширование

- **UserDefaults** для простых настроек
- **Keychain** для чувствительных данных
- **SwiftData** для сложных данных

### Обработка изображений

- **PhotosPicker** для выбора изображений
- **ImageRenderer** для создания изображений из View
- **Асинхронная загрузка** изображений
- **Кэширование** изображений

### Уведомления

- **UserNotifications** для локальных уведомлений
- **Push-уведомления** через APNs
- **Обработка разрешений** на уведомления
- **Категории уведомлений** для действий

## Производительность

### Мониторинг

- **OSLog** для отладки
- **Метрики производительности**
- **Обработка ошибок**

## Безопасность

### Хранение данных

- **Keychain** для токенов и паролей
- **Шифрование** чувствительных данных
- **Валидация** пользовательского ввода

### Сетевая безопасность

- **HTTPS** для всех запросов
- **Валидация** серверных ответов
- **Обработка** сетевых ошибок

## Сборка и развертывание

### Makefile команды

- **make setup** - настройка проекта
- **make format** - форматирование кода
- **make build** - сборка проекта
- **make test** - запуск тестов

## Миграция с SOTKA-OBJc и Android-SOTKA

### Источники для миграции

- **SOTKA-OBJc** - старое iOS приложение (не обновляется 2 года, отстает по актуальности)
- **Android-SOTKA** - актуальное Android приложение (регулярно обновляется, основной источник функциональности)
- **StreetWorkoutSU** - серверная часть проекта (PHP) и источник истины для API запросов и ответов

### Приоритеты миграции

1. **Основной функционал** - тренировки и прогресс
2. **Дневник тренировок** - просмотр и управление записями
3. **Прогресс и статистика** - визуализация результатов
4. **Дополнительные функции** - уведомления, обратная связь

### Основные функции Android-SOTKA для миграции

#### Навигация и структура

- **5 основных разделов**: Главная, Инфопосты, Дневник тренировок, Прогресс, Настройки
- **TabView навигация** между разделами
- **Модальные окна** для детальных экранов (в новом приложении используется NavigationStack, и только при необходимости - sheet)

#### Тренировки и программа

- **100-дневная программа** с блоками: Подготовка, Базовый, Продвинутый, Турбо, Завершение
- **Типы упражнений**: Подтягивания, Отжимания, Приседания, Австралийские подтягивания, Отжимания на коленях, Выпады
- **Циклы тренировок** (4+ круга в зависимости от дня)
- **Типы активности**: Тренировка, Растяжка, Отдых, Болезнь, Очистка
- **Дневник тренировок** с возможностью редактирования и удаления записей
- **Свободные тренировки** (дни 93, 95, 97)

#### Прогресс и статистика

- **3 контрольные точки**: 1-й день, 49-й день, 100-й день
- **Измерения**: максимумы в упражнениях (подтягивания, отжимания, приседания), вес
- **Фото прогресса**: фронтальное, сзади, сбоку для каждой контрольной точки
- **Синхронизация** с сервером
- **Визуализация прогресса** с графиками и сравнениями

#### Дополнительные функции

- **Обратная связь** и отзывы
- **Оценка приложения**
- **Социальные сети** (VK, Facebook)
- **Покупки** (расширенный редактор, календарь)
- **Синхронизация** между устройствами
- **Офлайн работа** с последующей синхронизацией

### Сохранение функциональности

- **Все основные функции** из Android-SOTKA (как наиболее актуальной версии)
- **Улучшенный UX** с современным дизайном SwiftUI
- **Лучшая производительность** и стабильность
- **Современные технологии** для долгосрочной поддержки
- **Полная совместимость** с существующими API сервера

## Запрещенные действия

### Что НЕЛЬЗЯ делать

- **Изменять файлы других проектов** без согласия
- **Использовать устаревшие технологии** (UIKit, Core Data), если можно использовать SwiftUI + SwiftData, но если нельзя реализовать при помощи SwiftUI нужную функциональность, то можно использовать UIKit
- **Нарушать архитектурные принципы** проекта
- **Пропускать форматирование** кода
- **Оставлять неиспользуемый код** после рефакторинга или завершения задач
- **Добавлять лишний код** без явного запроса (например, методы очистки кэша, которые нигде не используются)

### Что НУЖНО делать

- **Использовать современные технологии** SwiftUI + SwiftData
- **Поддерживать консистентность** кода
- **Документировать** сложную логику

## Специальные инструкции для Cursor

### При работе с кодом

1. **Всегда используй** современный стек SwiftUI + SwiftData + Observation
2. **Используй OSLog** для логирования вместо TODO комментариев
3. **Применяй правильное именование** функций и свойств
4. **ОФЛАЙН-ПРИОРИТЕТ**: Всегда реализуй локальное сохранение в SwiftData с флагами синхронизации
5. **Синхронизацию** делай опциональной и неблокирующей
6. **Тестируй** работу без интернета
7. См. также раздел "Запрещенные действия" для общих правил

### При создании новых компонентов

1. **Создавай ViewModels** с @Observable
2. **Используй environment** для передачи зависимостей
3. **Следуй модульной архитектуре** проекта
4. **Добавляй комментарии** для сложной логики
5. **Добавляй флаги синхронизации** (`isSynced`, `shouldDelete`, `lastModified`) во все модели
6. **Реализуй локальное сохранение** в SwiftData как приоритет
7. **Синхронизацию** делай асинхронной и неблокирующей

### При рефакторинге

1. **Сохраняй функциональность** из Android-SOTKA (как основного источника актуальной функциональности)
2. **Улучшай архитектуру** следуя современным принципам
3. **Проверяй форматирование** кода

### Терминология проектов

- **Новое приложение** = SwiftUI-SotkaApp (новое iOS приложение, которое мы разрабатываем сейчас)
- **Старое приложение** = SOTKA-OBJc (iOS приложение, не обновляется 2 года)
- **Андроид приложение** = Android-SOTKA (актуальное Android приложение, регулярно обновляется)

## Работа с другими проектами в workspace

### Доступные проекты для референса

- **Android-SOTKA** - актуальное Android приложение (основной источник функциональности для миграции)
- **SOTKA-OBJc** - старое iOS приложение (дополнительный источник, не обновляется 2 года)
- **StreetWorkoutSU** - серверная часть для API

### Правила работы с референсными проектами

- **Анализируй Android-SOTKA** как основной источник актуальной функциональности для миграции
- **Анализируй SOTKA-OBJc** для понимания iOS-специфичных особенностей реализованной логики и наличия/состояния UI-элементов на экранах (дополнительный источник)
- **Адаптируй функциональность** из Android-SOTKA под современный iOS стек
- См. также раздел "Запрещенные действия" для правил работы с файлами других проектов

### Специальные правила для Android-SOTKA

- **Android-SOTKA - основной источник** актуальной функциональности для миграции
- **Изучай структуру экранов** Android-SOTKA для понимания пользовательских сценариев
- **Анализируй API интеграцию** Android-SOTKA для совместимости с сервером
- **Копируй бизнес-логику** из Android-SOTKA, адаптируя под SwiftUI
- **Сохраняй все функции** из Android-SOTKA в новом iOS приложении
- **Используй Android-SOTKA** для понимания актуальных требований пользователей

### Специальные правила для экранов со списками

- **Добавляй интеграцию с сервером** там, где это это сделано в старом/андроид приложении

Следование этим правилам гарантирует создание качественного, поддерживаемого и масштабируемого приложения SotkaApp.

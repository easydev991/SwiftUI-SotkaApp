# Экран превью тренировки (Workout Preview Screen)

Этот документ описывает реализованный функционал экрана превью тренировки, устройство локального хранения, офлайн-приоритет и логику ViewModel `WorkoutPreviewViewModel.swift`.

## Оглавление

- [Краткий обзор функционала](#краткий-обзор-функционала)
- [Модель данных](#модель-данных)
- [Офлайн-приоритет](#офлайн-приоритет)
- [Сетевая интеграция (через `DailyActivitiesService`)](#сетевая-интеграция-через-dailyactivitiesservice)
- [Сервисы и ViewModel](#сервисы-и-viewmodel)
  - [WorkoutPreviewViewModel](#workoutpreviewviewmodel)
  - [WorkoutProgramCreator](#workoutprogramcreator)
- [UI: взаимодействие и поведение](#ui-взаимодействие-и-поведение)
- [Тестирование и качество](#тестирование-и-качество)
- [Принципы расширения](#принципы-расширения)
- [Ключевые правила](#ключевые-правила)
- [TODO](#todo)

### Краткий обзор функционала

- **Просмотр тренировки**: отображение упражнений дня с возможностью изменения количества повторений и кругов/подходов.
- **Типы выполнения**: выбор типа выполнения (Круги, Подходы, Турбо) для дней > 49, с автоматическим пересчетом упражнений.
- **Редактирование упражнений**: возможность изменения набора упражнений через редактор (только для типов Круги и Подходы).
- **Настройка времени отдыха**: выбор времени отдыха между подходами/кругами (от 5 до 600 секунд с шагом 5).
- **Комментарии**: добавление комментария к пройденной тренировке.
- **Сохранение**: сохранение тренировки как пройденной с локальным сохранением и последующей синхронизацией.
- **Отслеживание изменений**: автоматическое определение наличия изменений для активации кнопки "Сохранить".
- **Навигация**: переходы из дневника тренировок и главного экрана.

### Модель данных

#### WorkoutPreviewTraining

Структура для хранения данных упражнения в превью тренировки:

- `id: String` — уникальный идентификатор для идентификации в ViewModel и UI (не передается на сервер).
- `count: Int?` — количество повторений/подходов.
- `typeId: Int?` — идентификатор стандартного типа упражнения (соответствует `ExerciseType.rawValue`).
- `customTypeId: String?` — идентификатор пользовательского типа упражнения (соответствует `CustomExercise.id`).
- `sortOrder: Int?` — порядок следования в списке тренировок.

#### DayActivity

Модель SwiftData для хранения активности дня:

- `day: Int` — номер дня программы (1-100).
- `activityType: DayActivityType` — тип активности (`.workout` для тренировок).
- `count: Int?` — фактическое количество кругов/подходов (для пройденных тренировок).
- `plannedCount: Int?` — запланированное количество кругов/подходов.
- `executeType: ExerciseExecutionType` — тип выполнения (`.cycles`, `.sets`, `.turbo`).
- `duration: Int?` — продолжительность тренировки в секундах.
- `comment: String?` — комментарий к тренировке.
- `trainings: [DayActivityTraining]` — список упражнений тренировки.
- `isSynced: Bool` — синхронизировано ли состояние с сервером.
- `shouldDelete: Bool` — пометка на удаление.
- `lastModified: Date` — дата последнего изменения.

#### DayActivityTraining

Модель SwiftData для хранения упражнения в тренировке:

- `count: Int?` — количество повторений.
- `typeId: Int?` — идентификатор стандартного типа упражнения.
- `customTypeId: String?` — идентификатор пользовательского типа упражнения.
- `sortOrder: Int?` — порядок следования в списке.

### Офлайн-приоритет

- Все операции (создание, обновление) сначала сохраняются локально в SwiftData через `DailyActivitiesService`.
- Синхронизация с сервером выполняется асинхронно, неблокирующе для пользователя.
- При сетевых ошибках работа продолжается локально; состояние помечается как несинхронизированное.
- Время отдыха хранится в `AppSettings.restTime` (UserDefaults) и передается через Environment.
- Изменения отслеживаются через snapshot исходных данных в ViewModel для определения наличия изменений.

### Сетевая интеграция (через `DailyActivitiesService`)

Синхронизация тренировок происходит через `DailyActivitiesService`, который использует `DaysClient`/`SWClient`:

- `POST v3/100/days` — создание/обновление активности дня.
- `GET v3/100/days` — получение списка активностей пользователя.

Интерфейс сервиса:

- `createDailyActivity(_:context:)` — создание/обновление активности дня с локальным сохранением и последующей синхронизацией.

Модели запросов/ответов содержат все данные тренировки: упражнения с `typeId`, `customTypeId`, `count`, `sortOrder`, а также `executeType`, `plannedCount`, `count`, `comment`.

### Сервисы и ViewModel

#### WorkoutPreviewViewModel

ViewModel помечен `@MainActor` и `@Observable`. Все логи — на русском языке (`OSLog`).

**Публичные свойства**:

- `dayNumber: Int` — номер дня программы.
- `selectedExecutionType: ExerciseExecutionType?` — выбранный тип выполнения.
- `availableExecutionTypes: [ExerciseExecutionType]` — доступные типы выполнения для текущего дня.
- `trainings: [WorkoutPreviewTraining]` — список упражнений тренировки.
- `count: Int?` — фактическое количество кругов/подходов.
- `plannedCount: Int?` — запланированное количество кругов/подходов.
- `restTime: Int` — время отдыха между подходами/кругами (в секундах).
- `comment: String?` — комментарий к тренировке.
- `error: TrainingError?` — ошибка валидации при сохранении.
- `wasOriginallyPassed: Bool` — был ли день изначально пройден.
- `isWorkoutCompleted: Bool` — завершена ли тренировка (устанавливается после выполнения тренировки).
- `workoutDuration: Int?` — длительность выполненной тренировки в секундах.
- `displayedCount: Int?` — отображаемое количество кругов/подходов (computed property: `count ?? plannedCount`).
- `canEditComment: Bool` — можно ли редактировать комментарий (computed property: `isWorkoutCompleted || wasOriginallyPassed`).
- `isPlannedCountDisabled: Bool` — должен ли степпер для `plannedCount` быть отключен (true для `.turbo`).
- `hasChanges: Bool` — были ли внесены изменения после первоначальной загрузки.
- `shouldShowEditButton: Bool` — нужно ли показывать кнопку редактирования (только для `.cycles` и `.sets`).

**Загрузка данных**: `updateData(modelContext:day:restTime:)`

- Загружает существующую активность дня из SwiftData или создает новую через `WorkoutProgramCreator`.
- Инициализирует все свойства ViewModel из `WorkoutProgramCreator`.
- Создает snapshot исходных данных для отслеживания изменений.
- Логи: загрузка данных с указанием дня и статуса (новая/существующая).

**Обновление типа выполнения**: `updateExecutionType(_:)`

- Обновляет тип выполнения и пересчитывает упражнения через `WorkoutProgramCreator.withExecutionType(_:)`.
- Сохраняет пользовательские изменения `plannedCount` и `count` упражнений.
- При переходе на `.turbo` используются дефолтные значения.
- Логи: изменение типа выполнения с указанием нового типа.

**Обновление количества**: `updatePlannedCount(id:action:)`

- Обновляет количество повторений для упражнения или кругов/подходов через степпер.
- Поддерживает действия `.increment` и `.decrement`.
- Для упражнений использует метод `withCount(_:)` в `WorkoutPreviewTraining`.
- Логи: обновление количества с указанием ID и действия.

**Обновление комментария**: `updateComment(_:)`

- Обновляет комментарий тренировки.
- `nil` означает удаление комментария.

**Обновление времени отдыха**: `updateRestTime(_:)`

- Обновляет время отдыха между подходами/кругами.
- Значение сохраняется в `AppSettings.restTime` при сохранении тренировки.

**Обновление упражнений**: `updateTrainings(_:)`

- Обновляет список упражнений тренировки (используется редактором упражнений).
- Пересчитывает `sortOrder` на основе порядка в массиве (0, 1, 2, ...).
- Логи: обновление списка упражнений с указанием количества.

**Создание модели**: `buildDayActivity() -> DayActivity`

- Создает модель `DayActivity` из данных ViewModel через `WorkoutProgramCreator`.
- Если `workoutDuration` установлен, сохраняет его в `activity.duration`.
- Возвращает готовую модель для сохранения.

**Сохранение**: `saveTrainingAsPassed(activitiesService:modelContext:)`

- Валидирует данные перед сохранением (проверяет наличие типа выполнения и упражнений).
- Устанавливает `count = plannedCount`, если `count == nil` (для непройденных дней).
- Создает модель `DayActivity` через `buildDayActivity()`.
- Сохраняет через `DailyActivitiesService.createDailyActivity(_:context:)` с локальным сохранением и последующей синхронизацией.
- Логи: успешное сохранение тренировки с указанием дня.

**Определение показа пикера**: `shouldShowExecutionTypePicker(modelContext:day:)`

- Проверяет, что данные загружены (`dayNumber == day` и `trainings` не пустой).
- Получает `dayActivity` из базы данных для проверки пройденности дня.
- Если активность не найдена: показывается контрол, если доступно больше одного типа выполнения.
- Показывается только для не пройденных дней (`!dayActivity.isPassed`).
- Показывается только если доступно больше одного типа выполнения (`availableExecutionTypes.count > 1`).
- Для дней 50-91: показываются только "Круги" и "Подходы" (без "Турбо").
- Для дней 92-98: показываются все три опции — "Круги", "Подходы" и "Турбо".
- Для дней 1-49 и 99-100: не показывается (доступен только один тип).

**Отображение типа выполнения**: `displayExecutionType(for:)`

- Определяет фактический тип выполнения для турбо-дней через `WorkoutProgramCreator.getEffectiveExecutionType(for:dayNumber:executionType:)`.
- Использует `dayNumber` из ViewModel для правильного определения типа выполнения для турбо-дней.
- Для турбо-дней с подходами (93, 95, 98) возвращает `.sets`.
- Для турбо-дней с кругами (92, 94, 96, 97) возвращает `.cycles`.
- Для остальных типов возвращает исходный тип.

**Обработка результата тренировки**: `handleWorkoutResult(_:)`

- Обрабатывает результат выполнения тренировки из `WorkoutScreen`.
- Если `result.count == 0`: не обновляет состояние (позволяет пользователю снова начать тренировку без сохранения).
- Если `result.count > 0`: устанавливает `isWorkoutCompleted = true`, обновляет `count` и `workoutDuration` для отображения формы сохранения.
- Логи: обработка результата тренировки с указанием количества и длительности.

**Логирование (все сообщения на русском)**:

- Загрузка данных с указанием дня и статуса.
- Изменение типа выполнения с указанием нового типа.
- Обновление количества повторений и кругов/подходов.
- Обновление списка упражнений.
- Сохранение тренировки с указанием дня.
- Ошибки валидации при сохранении.

**Обработка ошибок**:

- `TrainingError.executionTypeNotSelected` — тип выполнения не выбран.
- `TrainingError.trainingsListEmpty` — список упражнений пуст.

#### WorkoutProgramCreator

Структура для генерации данных тренировки на основе номера дня и типа выполнения.

**Основные функции**:

- Генерация упражнений для дня в зависимости от блока программы (Базовый 1-49, Продвинутый 50-91, Турбо 92-98, Заключение 99-100).
- Расчет дефолтных значений `plannedCount` и `count` для каждого типа выполнения.
- Определение доступных типов выполнения для дня.
- Сохранение пользовательских изменений при смене типа выполнения через `withExecutionType(_:)`.
- Создание пользовательских упражнений через `withCustomExercises(_:)`.
- Маппинг между `DayActivity` и `WorkoutPreviewTraining`.
- Computed property `dayActivity: DayActivity` — создание модели `DayActivity` из данных `WorkoutProgramCreator`.

**Блоки программы**:

- **Базовый** (1-49): только тип `.cycles`, без выбора типа выполнения.
- **Продвинутый** (50-91): типы `.cycles` и `.sets`, дефолтный `.cycles`.
- **Турбо** (92-98): типы `.cycles`, `.sets` и `.turbo`, дефолтный `.cycles`.
- **Заключение** (99-100): только тип `.cycles`, без выбора типа выполнения.

### UI: взаимодействие и поведение

**Экран превью тренировки** (`WorkoutPreviewScreen`):

- Отображает сегментированный контрол выбора типа выполнения (если доступен).
- Показывает список упражнений с возможностью изменения количества повторений через степперы.
- Отображает счетчик кругов/подходов через `displayedCount` с возможностью изменения (отключен для типа `.turbo`).
- Показывает Picker для выбора времени отдыха (только для непройденных тренировок).
- Отображает поле для комментария через `canEditComment` (для завершенных или пройденных тренировок).
- Кнопки управления внизу экрана через `WorkoutPreviewButtonsView`:
  - Для непройденных: "Начать тренировку" и "Сохранить как пройденную".
  - Для пройденных: "Сохранить" (активна только при `hasChanges`).
  - Для завершенных тренировок (`isWorkoutCompleted`): "Сохранить" (всегда активна).
- Кнопка редактирования упражнений в toolbar (только для типов `.cycles` и `.sets`).
- Кнопка закрытия экрана в toolbar.
- Переход к экрану тренировки через `fullScreenCover` при нажатии "Начать тренировку":
  - Передает параметры тренировки: `dayNumber`, `executionType`, `trainings`, `plannedCount`, `restTime`.
  - Обрабатывает результат тренировки через `handleWorkoutResult(_:)` в замыкании `onWorkoutCompleted`.
  - Закрывает экран тренировки после обработки результата.

**Сегментированный контрол** (`WorkoutPreviewExecutionTypePicker`):

- Показывается только для не пройденных дней > 49.
- Отображает доступные типы выполнения для текущего дня.
- При изменении автоматически пересчитывает упражнения.

**Строка упражнения** (`TrainingRowView`):

- Отображает иконку упражнения, название и количество повторений.
- Содержит степпер для изменения количества (увеличение/уменьшение).
- Поддерживает отключение степпера через параметр `isDisabled`.

**Кнопки управления** (`WorkoutPreviewButtonsView`):

- Отображает кнопки в зависимости от статуса тренировки:
  - Для непройденных (`!isPassed && !isWorkoutCompleted`): "Начать тренировку" и "Сохранить как пройденную".
  - Для пройденных (`isPassed && !isWorkoutCompleted`): "Сохранить" (активна только при `hasChanges`).
  - Для завершенных тренировок (`isWorkoutCompleted`): "Сохранить" (всегда активна).

**Редактор упражнений** (`WorkoutExerciseEditorScreen`):

- Открывается через `.sheet` для модального отображения.
- Три секции: упражнения дня (с drag and drop), стандартные упражнения, пользовательские упражнения.
- Поддержка добавления/удаления упражнений с анимацией.
- Drag and drop для изменения порядка упражнений в первой секции.
- Кнопка "Готово" для сохранения изменений и возврата на экран превью.
- Кнопка закрытия для отмены изменений.

**Настройка времени отдыха**:

- Picker с навигационным стилем (`.navigationLink`).
- Диапазон значений: от 5 до 600 секунд с шагом 5.
- Дефолтное значение: 60 секунд (`Constants.defaultRestTime`).
- Показывается только для непройденных тренировок (`!wasOriginallyPassed`).
- Расположение: между счетчиком кругов/подходов и комментарием.

**Комментарий**:

- Показывается через `canEditComment` (для завершенных или пройденных тренировок).
- Редактируется через `SWTextEditor` с фокусом.
- Сохраняется в `DayActivity.comment` при сохранении тренировки.

**Точки входа**:

- `JournalScreen` — переход из дневника тренировок.
- `HomeActivitySectionView` — переход через меню "Изменить" → "Тренировка".

**Интеграция с экраном тренировки**:

- Переход к `WorkoutScreen` через `fullScreenCover` при нажатии "Начать тренировку".
- Передача параметров тренировки: `dayNumber`, `executionType`, `trainings`, `plannedCount`, `restTime`.
- Обработка результата тренировки через `handleWorkoutResult(_:)` в замыкании `onWorkoutCompleted`:
  - Если `result.count == 0`: не обновляет состояние (позволяет пользователю снова начать тренировку).
  - Если `result.count > 0`: устанавливает `isWorkoutCompleted = true`, обновляет `count` и `workoutDuration` для отображения формы сохранения.
- Автоматическое закрытие экрана тренировки после обработки результата.

### Тестирование и качество

- Unit-тесты для `WorkoutPreviewViewModel` — проверка загрузки данных, обновления типа выполнения, обновления количества, сохранения тренировки, отслеживания изменений, настройки времени отдыха.
- Unit-тесты для `WorkoutProgramCreator` — проверка генерации упражнений для разных дней и типов выполнения, сохранения пользовательских изменений, создания пользовательских упражнений.
- Unit-тесты для `WorkoutPreviewTraining` — проверка методов `withCount(_:)` и `isTurboExercise`.
- Unit-тесты для `WorkoutExerciseEditorScreen` — проверка добавления/удаления упражнений, drag and drop, сохранения изменений.
- Проверки локализации пользовательских строк и корректности логов (на русском).

### Принципы расширения

- Новые типы выполнения добавлять в `ExerciseExecutionType` с соответствующей логикой в `WorkoutProgramCreator`.
- Для новых блоков программы соблюдать офлайн-приоритет: локальное сохранение в первую очередь, синхронизация — отдельно и неблокирующе.
- Все сетевые операции — через абстракции сервисов (`DailyActivitiesService`), без прямых вызовов внутри View.
- Поддержка новых типов упражнений через расширение `ExerciseType` с соответствующими локализациями.
- ViewModel не должна хранить ссылки на `ModelContext` или `DailyActivitiesService` — они передаются в методы как параметры. Это упрощает тестирование и делает зависимости явными.

### Ключевые правила

- Не блокировать UI ожиданием сети в экране превью тренировки.
- Всегда писать логи на русском с достаточным контекстом.
- Обеспечивать работу без интернета для всех основных функций.
- Отслеживать изменения через snapshot исходных данных для активации кнопки "Сохранить".
- Сохранять пользовательские изменения при смене типа выполнения (кроме перехода на `.turbo`).
- Показывать кнопку редактирования только для типов `.cycles` и `.sets`.
- Отключать степпер для `plannedCount` при типе `.turbo`.
- Показывать Picker времени отдыха только для непройденных тренировок.
- Показывать поле комментария через `canEditComment` (для завершенных или пройденных тренировок).
- Использовать `buildDayActivity()` для создания модели `DayActivity` перед сохранением.
- Сохранять `workoutDuration` в `DayActivity.duration` при наличии значения.
- Использовать `WorkoutProgramCreator` для генерации упражнений и расчета дефолтных значений.
- Пересчитывать `sortOrder` при изменении списка упражнений в редакторе.
- При обработке результата тренировки с `count == 0` не обновлять состояние, чтобы пользователь мог снова начать тренировку.
- Для турбо-дней использовать `WorkoutProgramCreator.getEffectiveExecutionType(for:dayNumber:executionType:)` для определения фактического типа выполнения.

## TODO

- Реализовать кнопку "Продолжить" для активных (не завершенных) тренировок.
- Исправить дублирование названий турбо-упражнений для дня 95.
- Добавить типы упражнений 970, 971, 972 для дня 97 в режиме турбо (или реализовать логику использования правильных названий в зависимости от sortOrder).

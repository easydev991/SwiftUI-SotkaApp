# Экран таймера отдыха (Workout Timer Screen)

Этот документ описывает реализованный функционал экрана таймера отдыха, логику отслеживания времени, обработку сворачивания/разворачивания приложения и интеграцию с экраном тренировки.

## Оглавление

- [Краткий обзор функционала](#краткий-обзор-функционала)
- [Компоненты UI](#компоненты-ui)
- [Реализация](#реализация)
  - [WorkoutTimerScreen](#workouttimerscreen)
  - [CircularTimerView](#circulartimerview)
- [UI: взаимодействие и поведение](#ui-взаимодействие-и-поведение)
- [Интеграция с экраном тренировки](#интеграция-с-экраном-тренировки)
- [Обработка фонового режима](#обработка-фонового-режима)
- [Локализация](#локализация)
- [Стилизация](#стилизация)
- [Принципы расширения](#принципы-расширения)
- [Ключевые правила](#ключевые-правила)

### Краткий обзор функционала

- **Обратный отсчет времени**: отображение оставшегося времени отдыха с круговым прогресс-баром и текстовым индикатором в формате MM:SS.
- **Досрочное завершение**: возможность завершить отдых досрочно через кнопку "Завершить".
- **Автоматическое завершение**: таймер автоматически закрывается при достижении 0 секунд.
- **Обработка фонового режима**: корректная работа при сворачивании/разворачивании приложения с вычислением правильного оставшегося времени на основе реального прошедшего времени.
- **Предотвращение ускоренной анимации**: отключение анимации при разворачивании приложения для предотвращения ускоренной анимации таймера.
- **Интеграция**: показывается через `fullScreenCover` из экрана тренировки с обработкой завершения через замыкание `onDismiss`.

### Компоненты UI

- **WorkoutTimerScreen** — основной экран таймера отдыха с заголовком, круговым таймером и кнопкой завершения.
- **CircularTimerView** — компонент кругового прогресс-бара с отображением времени в формате MM:SS и поддержкой анимации.

### Реализация

#### WorkoutTimerScreen

Экран таймера отдыха реализован как SwiftUI View без отдельной ViewModel. Вся логика находится внутри View.

**Параметры**:

- `duration: Int` — длительность таймера в секундах (передается из `WorkoutScreen`).
- `onFinish: (_ force: Bool) -> Void` — замыкание, вызываемое при завершении таймера (с параметром `force` для различения досрочного и автоматического завершения).

**Состояние (@State)**:

- `startTime: Date?` — время начала таймера (устанавливается в `onAppear`).
- `pausedTime: Date?` — время паузы при сворачивании приложения (для корректного вычисления времени).
- `remainingSeconds: Int` — оставшееся время в секундах (для обновления UI).
- `shouldAnimate: Bool` — флаг включения/выключения анимации (для предотвращения ускоренной анимации при разворачивании).

**Таймер**:

- Используется `Timer.publish(every: 0.5, on: .main, in: .common).autoconnect()` для автоматического обновления каждые 0.5 секунды.
- Таймер автоматически отключается при отсутствии подписчиков (например, при закрытии View).
- В `onDisappear` вызывается `timer.upstream.connect().cancel()` для явной отмены таймера.
- В `onReceive(timer)` проверяется наличие `startTime` (`guard let startTime else { return }`).
- Если таймер истек на основе реального времени (`elapsed >= duration`), метод возвращается без вызова `onFinish` (обработка произойдет через `checkAndHandleExpiredRestTimer` в ViewModel).

**Вычисление оставшегося времени**:

- Вместо простого уменьшения счетчика используется вычисление на основе времени начала (`startTime`).
- Метод `updateRemainingSeconds()` вычисляет прошедшее время:
  - Если приложение свернуто (`pausedTime != nil`): `elapsed = pausedTime.timeIntervalSince(startTime)` (используется время до паузы).
  - Если приложение активно: `elapsed = Date().timeIntervalSince(startTime)`.
- `remainingSeconds = max(0, duration - Int(elapsed.rounded()))` (округление до ближайшего целого, так как обновление происходит каждые 0.5 секунды).
- Обновление происходит только если новое значение отличается от текущего (`if newRemaining != remainingSeconds`).

**Обработка сворачивания/разворачивания**:

- Отслеживается `scenePhase` через `.onChange(of: scenePhase)` с вызовом `handleScenePhaseChange(from:to:)`.
- Метод `handleScenePhaseChange` проверяет наличие `startTime` в начале (`guard let startTime else { return }`).
- При сворачивании (`.active` → `.background`/`.inactive`): сохраняется `pausedTime = .now`.
- При разворачивании (`.background`/`.inactive` → `.active`):
  - Вычисляется правильное оставшееся время на основе реального прошедшего времени: `elapsed = Date().timeIntervalSince(startTime)`.
  - Если таймер уже истек (`elapsed >= duration`), устанавливается `remainingSeconds = 0`, отключается анимация и очищается `pausedTime` (обработка завершения произойдет через `checkAndHandleExpiredRestTimer` в ViewModel).
  - Если таймер не истек, отключается анимация (`shouldAnimate = false`) для резкого перехода.
  - Обновляется `remainingSeconds` с правильным значением: `max(0, duration - Int(elapsed))`.
  - Включается анимация обратно после небольшой задержки (0.1 секунды через `DispatchQueue.main.asyncAfter`).
  - Очищается `pausedTime`.

**Завершение таймера**:

- Автоматическое: при достижении `remainingSeconds <= 0` в `onReceive(timer)` вызывается `finishTimer(force: false)` с задержкой в 1 секунду через `DispatchQueue.main.asyncAfter(deadline: .now() + 1.0)`.
- Досрочное: при нажатии кнопки "Завершить" вызывается `finishTimer(force: true)` без задержки.
- Если таймер истек на основе реального времени (при разворачивании приложения или в `updateRemainingSeconds()`), он не вызывает `onFinish` сразу, а ждет обработки через `checkAndHandleExpiredRestTimer` в ViewModel.
- `finishTimer(force:)` отменяет таймер через `timer.upstream.connect().cancel()` и вызывает `onFinish(force:)` для обработки завершения в ViewModel.

#### CircularTimerView

Компонент кругового прогресс-бара с отображением времени.

**Параметры**:

- `remainingSeconds: Int` — оставшееся время в секундах.
- `totalSeconds: Int` — общая длительность таймера в секундах.
- `shouldAnimate: Bool` — флаг включения/выключения анимации (по умолчанию `true`).

**Вычисляемые свойства**:

- `progress: CGFloat` — прогресс от 0.0 до 1.0: `(totalSeconds - remainingSeconds) / totalSeconds`.
- `timeString: String` — форматированная строка времени в формате MM:SS: `String(format: "%02d:%02d", minutes, seconds)`.

**Структура компонента**:

- Фоновый круг: `Circle().stroke(Color.gray.opacity(0.3), lineWidth: 8)` — незаполненная часть.
- Прогресс-бар: `Circle().trim(from: 0, to: 1.0 - progress).stroke(Color.swAccent, style: StrokeStyle(lineWidth: 8, lineCap: .round))` — заполненная часть с анимацией.
- Текст времени: `Text(timeString).font(.largeTitle).bold().monospacedDigit()` — отображение времени в центре с моноширинным шрифтом для предотвращения "прыжков" цифр.

**Анимация**:

- Плавная анимация обновления прогресса: `.linear(duration: 1.0)` (если `shouldAnimate == true`).
- Анимация привязана к изменению `remainingSeconds`.
- При `shouldAnimate == false` анимация отключается для резкого перехода (используется при разворачивании приложения).

### UI: взаимодействие и поведение

**Экран таймера отдыха** (`WorkoutTimerScreen`):

- Полноэкранный экран с фоном `Color.swBackground` (адаптируется к светлой/темной теме).
- Структура экрана:
  - Заголовок "Отдых" вверху (`.timerScreenTitle`).
  - Круговой таймер в центре с отображением оставшегося времени.
  - Кнопка "Завершить" внизу (`.timerScreenFinishButton`) со стилем `SWButtonStyle(mode: .tinted, size: .large)`.
- Автоматически запускается при появлении экрана (`onAppear` устанавливает `startTime`).
- Обновляется каждую секунду через `Timer.publish`.
- Автоматически закрывается при достижении 0 секунд.
- Позволяет досрочно завершить отдых через кнопку "Завершить".

**Компонент кругового таймера** (`CircularTimerView`):

- Отображает круговой прогресс-бар с акцентным цветом (`Color.swAccent`).
- Показывает оставшееся время в формате MM:SS в центре.
- Использует моноширинный шрифт (`.monospacedDigit()`) для предотвращения "прыжков" цифр при изменении времени.
- Поддерживает отключение анимации для резкого перехода при разворачивании приложения.

### Интеграция с экраном тренировки

**Использование в WorkoutScreen**:

- Показывается через `fullScreenCover(isPresented: $vm.showTimer)`.
- Передается `duration: restTime` (время отдыха из параметров тренировки).
- Передается замыкание `onFinish: { force in vm.handleTimerFinish(force: force, appSettings: appSettings) }` для обработки завершения таймера.
- При активации приложения (разворачивании) вызывается `vm.checkAndHandleExpiredRestTimer(appSettings: appSettings)` для проверки и обработки истекшего таймера.

**Обработка завершения таймера**:

- Звук и вибрация воспроизводятся в `WorkoutScreenViewModel.handleTimerFinish()` только при автоматическом завершении (`force == false`).
- Фактическое время отдыха засекается в момент закрытия экрана таймера (в `handleTimerFinish` на основе `currentRestStartTime`).
- Уведомление о завершении отдыха отменяется при закрытии экрана таймера.
- При досрочном завершении (`force == true`) звук и вибрация не воспроизводятся.
- При автоматическом завершении (`force == false`) есть задержка в 1 секунду перед вызовом `onFinish` для плавного перехода.

### Обработка фонового режима

**При сворачивании приложения**:

- Таймер продолжает работать в фоне через `Timer.publish`.
- Сохраняется `pausedTime = .now` для корректного вычисления времени при разворачивании.

**При разворачивании приложения**:

- Вычисляется правильное оставшееся время на основе реального прошедшего времени: `elapsed = Date().timeIntervalSince(startTime)`.
- Если таймер уже истек, устанавливается `remainingSeconds = 0` и обработка завершения происходит через `checkAndHandleExpiredRestTimer` в ViewModel.
- Если таймер не истек, отключается анимация (`shouldAnimate = false`) для предотвращения ускоренной анимации.
- Обновляется `remainingSeconds` с правильным значением.
- Включается анимация обратно после небольшой задержки (0.1 секунды).
- В `WorkoutScreen` при активации приложения вызывается `checkAndHandleExpiredRestTimer` для проверки истекшего таймера.

**Преимущества подхода**:

- Корректное отображение времени при разворачивании приложения (не зависит от количества пропущенных обновлений таймера).
- Предотвращение ускоренной анимации при разворачивании (отключение анимации при резком переходе).
- Работа в фоне: `Timer.publish` продолжает работать, при возврате в приложение UI обновится с актуальным значением.

### Локализация

**Ключи локализации**:

- `"TimerScreen.Title"` — "Отдых" (заголовок экрана).
- `"TimerScreen.FinishButton"` — "Завершить" (кнопка досрочного завершения).

**Форматирование времени**:

- Время отображается в формате MM:SS через `String(format: "%02d:%02d", minutes, seconds)`.
- Используется моноширинный шрифт (`.monospacedDigit()`) для предотвращения "прыжков" цифр.

### Стилизация

**Фон экрана**:

- Используется стандартный фон системы: `Color.swBackground`.
- Адаптируется к светлой/темной теме автоматически.

**Кнопка завершения**:

- Стиль: `SWButtonStyle(mode: .tinted, size: .large)`.
- Аналогична кнопке "Завершить отдых" в других экранах приложения.
- Цвет текста: `.swAccent`.
- Фон: `.swTintedButton` (прозрачный с акцентным цветом).

**Круговой прогресс-бар**:

- Цвет прогресса: `Color.swAccent`.
- Цвет фона: `Color.gray.opacity(0.3)`.
- Толщина линии: 8pt.
- Размер: 250x250pt (максимальный размер, адаптируется к содержимому).
- Скругление концов: `.round` (lineCap).
- Начало анимации: сверху (`.rotationEffect(.degrees(-90))`).

**Текст времени**:

- Шрифт: `.largeTitle.bold()`.
- Модификатор: `.monospacedDigit()` для предотвращения "прыжков" при изменении цифр.
- Цвет: стандартный цвет текста системы.

### Принципы расширения

- Новые функции таймера (например, пауза/возобновление) добавлять через расширение состояния View.
- Для новых типов таймеров использовать тот же подход с вычислением времени на основе `startTime`.
- Поддержка новых форматов времени через расширение `timeString` в `CircularTimerView`.
- Все изменения состояния таймера должны учитывать обработку фонового режима.

### Ключевые правила

- Использовать вычисление времени на основе `startTime`, а не простое уменьшение счетчика, для корректной работы в фоновом режиме.
- Отключать анимацию при разворачивании приложения для предотвращения ускоренной анимации.
- Отслеживать `scenePhase` для обработки сворачивания/разворачивания приложения.
- Отменять таймер в `onDisappear` для явной очистки ресурсов.
- Использовать моноширинный шрифт (`.monospacedDigit()`) для отображения времени для предотвращения "прыжков" цифр.
- Показывать экран таймера через `fullScreenCover` для полноэкранного отображения поверх экрана тренировки.
- Обработка завершения таймера (звук, вибрация, уведомления) выполняется в `WorkoutScreenViewModel.handleTimerFinish()`, а не в самом экране таймера.
- Фактическое время отдыха засекается в момент закрытия экрана таймера (в `handleTimerFinish` на основе `currentRestStartTime`).
- При разворачивании приложения проверять истекший таймер через `checkAndHandleExpiredRestTimer` в ViewModel.
- Использовать замыкание `onFinish` с параметром `force` для различения досрочного и автоматического завершения.

# Экран прогресса (Progress)

Этот документ описывает реализованный функционал экрана прогресса, устройство локального хранения, офлайн-приоритет и логику сервисов `ProgressService.swift` и `ProgressSyncService.swift`.

### Краткий обзор функционала

- **Статистика прогресса**: горизонтальная визуализация прогресса с 100 сегментами, показывающая статусы дней (текущий, завершенный, частичный, пропущенный, не начатый).
- **Информационная панель**: детальная статистика с процентами полного прогресса, инфопостов и активности.
- **Сетка прогресса**: табличное отображение данных прогресса для трех контрольных точек (день 1, день 49, день 100) с метриками (подтягивания, отжимания, приседания, вес) и фотографиями (спереди, сзади, сбоку).
- **Редактирование прогресса**: два режима редактирования (метрики и фотографии) с валидацией данных и обработкой изображений.
- **Удаление прогресса**: мягкое удаление с последующей синхронизацией на сервер.
- **Навигация**: переход к экрану прогресса с главного экрана (когда не заполнены максимумы) и из профиля.
- **Синхронизация**: двунаправленная синхронизация с сервером с разрешением конфликтов по стратегии LWW (Last Write Wins).

### Компоненты UI

- **ProgressScreen** — основной экран прогресса с статистикой и сеткой. Использует `ProgressDestination` для навигации к редактированию.
- **ProgressStatsView** — компонент статистики с прогресс-баром и информационным листом.
- **ProgressBarView** — горизонтальный прогресс-бар с 100 сегментами для визуализации статусов дней.
- **ProgressStatsInfoView** — детальная информация о статистике с процентами и легендой статусов.
- **ProgressStatsViewModel** — ViewModel для расчета статистики прогресса.
- **ProgressCalculator** — логика расчета статистики по инфопостам и активностям.
- **ProgressGridView** — сетка (Grid) для отображения данных прогресса для контрольных точек.
- **EditProgressScreen** — экран редактирования прогресса с переключением между режимами метрик и фотографий.
- **HomeFillProgressSectionView** — секция на главном экране для перехода к заполнению прогресса.
- **ProgressDestination** — enum для управления навигацией (`.editProgress`, `.editPhotos`).

### Модель данных: `UserProgress`

- `id: Int` — идентификатор, совпадает с номером дня (1, 49, 100).
- `pullUps: Int?` — максимум подтягиваний.
- `pushUps: Int?` — максимум отжиманий.
- `squats: Int?` — максимум приседаний.
- `weight: Float?` — вес пользователя.
- `urlPhotoFront: String?` — URL фотографии спереди.
- `urlPhotoBack: String?` — URL фотографии сзади.
- `urlPhotoSide: String?` — URL фотографии сбоку.
- `dataPhotoFront: Data?` — локальные данные изображения спереди (кэш).
- `dataPhotoBack: Data?` — локальные данные изображения сзади (кэш).
- `dataPhotoSide: Data?` — локальные данные изображения сбоку (кэш).
- `isSynced: Bool` — синхронизировано ли состояние с сервером.
- `shouldDelete: Bool` — пометка на удаление (элемент скрывается из UI, удаляется на сервере при следующей синхронизации).
- `lastModified: Date` — дата последнего изменения (используется как источник истины при разрешении конфликтов).
- `user: User?` — связь с пользователем через `@Relationship`.

Модель поддерживает три контрольные точки программы:
- **День 1** (Базовый блок) — начало программы.
- **День 49** (Продвинутый блок) — середина программы.
- **День 100** (Заключение) — конец программы.

Дополнительные свойства и методы:
- `isMetricsFilled: Bool` — проверяет, заполнены ли все результаты прогресса.
- `hasAnyMetricsData: Bool` — проверяет наличие хотя бы каких-то данных (больше нуля).
- `section: Section` — блок программы на основе номера дня.
- `isEmpty: Bool` — проверяет, является ли прогресс "пустым" (нет значимых данных).
- `canBeDeleted: Bool` — проверяет, можно ли удалить прогресс.
- `DataType` enum — типы данных прогресса (weight, pullUps, pushUps, squats) с локализованными названиями и иконками.
- `Section` enum — блоки программы (one, two, three) с маппингом дней.
- `getExternalDayFromProgressId(_:)` — маппинг внутренних дней в внешние дни сервера.
- `getInternalDayFromExternalDay(_:)` — обратный маппинг внешних дней во внутренние.
- Методы работы с фотографиями: `getPhotoData(_:)`, `getPhotoURL(_:)`, `setPhotoData(_:type:)`, `deletePhotoData(_:)`, `shouldDeletePhoto(_:)`, `clearPhotoData(_:)`, `hasPhoto(_:)`.
- `DELETED_DATA` — константа для пометки удаленных фотографий (байт "d").

### Офлайн-приоритет

- Все операции (создание, обновление, удаление) сначала сохраняются локально в SwiftData.
- Синхронизация с сервером выполняется асинхронно, неблокирующе для обычных пользовательских действий.
- При сетевых ошибках работа продолжается локально; состояние помечается как несинхронизированное.
- Конфликты разрешаются автоматически по стратегии LWW (Last Write Wins) на основе поля `lastModified`.
- Фотографии хранятся локально в виде `Data` для быстрого доступа и загружаются с сервера при необходимости.

### Сетевая интеграция (через `ProgressClient`/`SWClient`)

- `GET /100/progress` — получение списка прогресса пользователя.
- `GET /100/progress/{day}` — получение прогресса для конкретного дня.
- `POST /100/progress` — создание нового прогресса.
- `POST /100/progress/{day}` — обновление существующего прогресса (используется для создания и обновления).
- `DELETE /100/progress/{day}` — удаление прогресса для конкретного дня.
- `DELETE /100/progress/{day}/photos/{type}` — удаление фотографии определенного типа.

Интерфейс клиента:
- `getProgress() async throws -> [ProgressResponse]`
- `getProgress(day: Int) async throws -> ProgressResponse`
- `createProgress(progress: ProgressRequest) async throws -> ProgressResponse`
- `updateProgress(day: Int, progress: ProgressRequest) async throws -> ProgressResponse`
- `deleteProgress(day: Int) async throws`
- `deletePhoto(day: Int, type: String) async throws`

**Важно**: Приложение использует внутренние дни (1, 49, 100) для локального хранения, но отправляет на сервер внешние дни (1, 49, 99) согласно логике маппинга:
- День 1 → серверный день 1
- День 49 → серверный день 49
- День 100 → серверный день 99

Модели запросов/ответов содержат ISO-строки дат (`create_date`, `modify_date`) и поля `pullups`, `pushups`, `squats`, `weight`, `photo_front`, `photo_back`, `photo_side`.

### Сервисы

#### ProgressService

Сервис помечен `@MainActor` и `@Observable`. Все логи — на русском языке (`OSLog`).

- **Публичные свойства**:
  - `displayMode: ProgressDisplayMode` — режим отображения (метрики или фотографии).
  - `metricsModel: TempMetricsModel` — временная модель метрик для редактирования.
  - `photoModels: [TempPhotoModel]` — временные модели фотографий для редактирования.
  - `progress: UserProgress` — доступ к модели прогресса.

- **Загрузка данных**: `loadProgress()`
  - Загружает данные прогресса в сервис для редактирования.
  - Создает временные модели для метрик и фотографий.
  - Логи: успешная загрузка данных с деталями.

- **Сохранение**: `saveProgress(context:)`
  - Валидирует данные перед сохранением.
  - Обновляет модель прогресса с данными из временных моделей.
  - Устанавливает связь с пользователем, если она не установлена.
  - Сохраняет в SwiftData и помечает как несинхронизированное.
  - Логи: успешное сохранение с указанием, что синхронизация выполняется отдельно.

- **Удаление (soft)**: `deleteProgress(context:)`
  - Не удаляет объект физически сразу.
  - Ставит `shouldDelete = true`, `isSynced = false`, обновляет `lastModified`.
  - UI фильтрует такие элементы и не показывает их пользователю.
  - Логи: пометка для удаления с указанием, что синхронизация выполняется отдельно.

- **Управление фотографиями**: `pickTempPhoto(_:type:)`, `deleteTempPhoto(type:)`
  - Обрабатывает выбор фотографий из камеры или библиотеки.
  - Валидирует размер и формат изображений.
  - Обрабатывает изображения через `ImageProcessor` для оптимизации.
  - Сохраняет фотографии во временные модели для последующего сохранения.
  - Логи: успешное обновление фотографий с деталями.

- **Проверка возможности сохранения**: `canSave`
  - Валидирует только заполненные поля (сервер позволяет частичное заполнение).
  - Разрешает 0 как допустимое значение.
  - Проверяет наличие изменений по сравнению с исходными данными.

- **Обработка ошибок**: `ServiceError` enum
  - `invalidData` — некорректные данные прогресса.
  - `userNotFound` — пользователь не найден.
  - `invalidImageData` — некорректные данные изображения.
  - `invalidPhotoType` — неподдерживаемый тип фотографии.
  - `imageProcessingFailed` — ошибка обработки изображения.
  - `photoNotFound` — фотография не найдена.

#### ProgressSyncService

Сервис помечен `@MainActor` и `@Observable`. Все логи — на русском языке (`OSLog`).

- **Публичные свойства**:
  - `isSyncing: Bool` — индикатор синхронизации (неблокирующий для UI).

- **Двунаправленная синхронизация**: `syncProgress(context:) async throws -> SyncResult`
  - Сначала отправляет локальные изменения на сервер (локальные → сервер).
  - Затем загружает серверные изменения (сервер → локальные) с автоматическим разрешением конфликтов по LWW.
  - Очищает дубликаты перед и после синхронизации.
  - Возвращает `SyncResult` с деталями синхронизации (статистика, ошибки).
  - Защита от параллельных синхронизаций через `isSyncing` флаг и `AlreadySyncingError`.
  - Обработка `CancellationError` с повторной попыткой загрузки через 1 секунду.
  - Логи: подробное отслеживание всех этапов синхронизации.

- **Подготовка снимков**: `makeProgressSnapshotsForSync(context:)`
  - Создает неизменяемые снимки данных для параллельной обработки.
  - Фильтрует записи, требующие синхронизации (несинхронизированные или помеченные для удаления).
  - Проверяет записи на "пустоту" и помечает для удаления при необходимости.
  - Логи: детальная диагностика всех записей для синхронизации.

- **Параллельная синхронизация**: `runSyncTasks(snapshots:client:)`
  - Выполняет параллельные сетевые операции для всех записей через `TaskGroup`.
  - Формирует события синхронизации для каждого снимка:
    - `.createdOrUpdated(id:server)` — сервер вернул актуальную сущность.
    - `.alreadyExists(id)` — локальная запись уже существует на сервере.
    - `.deleted(id)` — сервер подтвердил удаление.
    - `.needsPhotoDeletion(id)` — требуется удаление фотографий.
    - `.failed(id:errorDescription)` — ошибка сети/сервера.
  - Логи: отслеживание параллельных операций и результатов.

- **Применение результатов**: `applySyncEvents(_:context:)`
  - Применяет все события синхронизации к `ModelContext` одним проходом на главной очереди.
  - Для `createdOrUpdated` — обновление локальной сущности данными ответа сервера, `isSynced = true`, `shouldDelete = false`, даты приводятся из серверных строк.
  - Для `alreadyExists` — помечает как синхронизированную.
  - Для `deleted` — физическое удаление локального объекта.
  - Для `needsPhotoDeletion` — последовательное удаление фотографий.
  - Для `failed` — только логирование, локальное состояние сохраняется для последующих повторов.
  - Удаляет локальные записи, которые помечены для удаления, но никогда не были синхронизированы.
  - Логи: детальное отслеживание применения всех событий.

- **Загрузка с сервера и LWW**: `downloadServerProgress(context:)`
  - Загружает все записи прогресса пользователя с сервера.
  - Сопоставляет с локальными по внутреннему ID с учетом маппинга дней.
  - Применяет стратегию LWW для разрешения конфликтов:
    - Если `local.lastModified > server.modify_date` — сохраняется локальная версия (мы уже отправили изменения).
    - Если `server.modify_date > local.lastModified` — локальная сущность обновляется по данным сервера и помечается синхронизированной.
    - Если даты одинаковые, но данные различаются — приоритет серверной версии.
  - Для синхронизированных элементов, отсутствующих на сервере, — ставится `shouldDelete = true` и `isSynced = false` (или выполняется физическое удаление, если удаление уже подтверждалось событием).
  - Обновляет фотографии из ответов сервера через `PhotoDownloadService`.
  - Логи: детальное отслеживание разрешения конфликтов и применения серверных данных.

- **Обработка удаления фотографий**: `handlePhotoDeletion(_:context:)`
  - Последовательно удаляет фотографии для каждой контрольной точки.
  - Отправляет запросы на удаление на сервер через `deletePhoto(day:type:)`.
  - Очищает локальные данные фотографий после успешного удаления.
  - Если после удаления есть новые фотографии для отправки, отправляет их после удаления старых.
  - Помечает прогресс как синхронизированный только если не было ошибок.
  - Логи: детальное отслеживание удаления каждой фотографии.

- **Очистка дубликатов**: `cleanupDuplicateProgress(context:)`
  - Находит дубликаты прогресса для одного дня.
  - Сортирует по приоритету: сначала синхронизированные, потом по дате модификации.
  - Оставляет только самую приоритетную запись, удаляет остальные.
  - Логи: детальное отслеживание очистки дубликатов.

- **Логирование (все сообщения на русском)**:
  - Старт/завершение синхронизаций, количество элементов к синку.
  - Подробности запросов при отправке (id, метрики, даты, фотографии).
  - Результаты применения: «обновлено локально», «удалено локально», «пропущено (локальная версия новее)».
  - Ошибки сети/применения с `error.localizedDescription` и деталями `APIError`, если доступен.
  - Детальное отслеживание всех этапов синхронизации с эмодзи для удобства чтения логов.

### Статистика прогресса

#### ProgressCalculator

Структура для расчета статистики прогресса на основе данных пользователя и текущего дня.

- **Полный прогресс** (`fullProgressPercent`): дни с активностью И прочитанным инфопостом в пределах текущего дня программы.
- **Прогресс по инфопостам** (`infoPostsPercent`): процент прочитанных инфопостов из 100 возможных.
- **Прогресс по активностям** (`activityPercent`): процент дней с активностью из 100 возможных (исключая помеченные для удаления).
- **Статусы дней** (`dayStatuses`): массив статусов для всех 100 дней:
  - `.currentDay` (синий) — текущий день программы.
  - `.completed` (зеленый) — активность + инфопост.
  - `.partial` (желтый) — только активность ИЛИ только инфопост.
  - `.skipped` (красный) — день в пределах программы, но нет активности и инфопоста.
  - `.notStarted` (серый) — день еще не начался (будущие дни).

#### ProgressStatsViewModel

ViewModel для управления состоянием статистики прогресса.

- **Публичные свойства**:
  - `fullProgressPercent: Int` — процент полного прогресса.
  - `infoPostsPercent: Int` — процент прогресса по инфопостам.
  - `activityPercent: Int` — процент прогресса по активностям.
  - `dayStatuses: [DayProgressStatus]` — статусы всех дней.

- **Обновление статистики**: `updateStats(modelContext:currentDay:)`
  - Загружает пользователя из базы данных.
  - Создает `ProgressCalculator` для расчета статистики.
  - Обновляет все свойства ViewModel.
  - Логи: успешное обновление статистики с процентами.

### UI: взаимодействие и поведение

- **Экран прогресса** (`ProgressScreen`):
  - Отображает статистику прогресса вверху с возможностью открытия детальной информации.
  - Показывает сетку прогресса для трех контрольных точек.
  - Навигация к редактированию метрик или фотографий через `ProgressDestination` enum при нажатии на соответствующие элементы.
  - Фильтрует элементы с `shouldDelete = true` из отображения.
  - Использует `navigationDestination(item:)` для управления навигацией.

- **Сетка прогресса** (`ProgressGridView`):
  - Отображает данные в виде `Grid` (не таблицы) с заголовками для каждого дня.
  - Показывает метрики (подтягивания, отжимания, приседания, вес) с иконками через `UserProgress.DataType`.
  - Показывает фотографии (спереди, сзади, сбоку) с приоритетом локальных данных над URL.
  - Отключает редактирование для дней, которые еще не достигнуты (сравнение с текущим днем).
  - Создает заглушки для дней, для которых нет данных прогресса.
  - Использует `UserProgress.Section` для группировки по блокам программы.

- **Редактирование прогресса** (`EditProgressScreen`):
  - Два режима редактирования: метрики и фотографии.
  - Переключение между режимами через `Picker` вверху экрана.
  - В режиме метрик: ввод данных упражнений и веса с валидацией и навигацией между полями через `FocusableField` enum.
  - Автоматическая прокрутка к активному полю при фокусе.
  - Навигация между полями через кнопки на клавиатуре (предыдущее/следующее).
  - В режиме фотографий: выбор фотографий из камеры или библиотеки через `SWImagePicker` с обработкой и удалением.
  - Кнопка сохранения доступна только при наличии изменений и валидных данных.
  - Кнопка удаления доступна только если прогресс содержит данные (`canBeDeleted`).
  - Автоматическое закрытие клавиатуры при навигации между полями.

- **Главный экран** (`HomeFillProgressSectionView`):
  - Отображается только когда не заполнены максимумы для текущего дня (`!isMaximumsFilled`).
  - Переход к экрану прогресса через `NavigationLink` с `HomeScreen.NavigationDestination.userProgress`.
  - Скрывается после заполнения всех контрольных точек.

- **Статистика прогресса** (`ProgressStatsView`):
  - Отображает горизонтальный прогресс-бар с 100 сегментами.
  - При нажатии открывает модальное окно с детальной информацией.
  - Обновляется автоматически при появлении на экране.

### Тестирование и качество

- Unit-тесты для `ProgressCalculator` — проверка расчета статистики по инфопостам и активностям.
- Unit-тесты для `ProgressSyncService` — проверка синхронизации прогресса, включая:
  - Успешную синхронизацию с сервером.
  - Параллельную отправку несинхронизированных записей.
  - Обработку конфликтов по стратегии LWW.
  - Удаление фотографий.
  - Очистку дубликатов.
- Unit-тесты для `ProgressService` — проверка создания, обновления и удаления прогресса.
- Проверки локализации пользовательских строк и корректности логов (на русском).

### Принципы расширения

- Новые поля в `UserProgress` добавлять с учетом мягких миграций SwiftData.
- Для новых операций соблюдать офлайн-приоритет: локальные изменения в первую очередь, синхронизация — отдельно и неблокирующе.
- Все сетевые операции — через абстракции клиентов (`ProgressClient`), без прямых вызовов внутри View.
- Поддержка новых контрольных точек через расширение логики маппинга дней.
- Обработка фотографий через `ImageProcessor` для оптимизации размера и формата.

### Ключевые правила

- Не блокировать UI ожиданием сети в экране прогресса.
- Всегда писать логи на русском с достаточным контекстом.
- Разрешать конфликты автоматически по `lastModified` (LWW).
- Soft delete: сначала пометка и скрытие в UI, потом удаление на сервере и физическое удаление локально.
- Использовать маппинг дней при работе с сервером (внутренние дни 1, 49, 100 → внешние дни 1, 49, 99).
- Очищать дубликаты перед и после синхронизации для предотвращения конфликтов.
- Приоритет локальных данных фотографий над URL для быстрого отображения.
- Валидировать только заполненные поля, разрешать 0 как допустимое значение.
- Последовательно удалять фотографии при необходимости (как в старом приложении).
- Обновлять фотографии из ответов сервера через `PhotoDownloadService` для синхронизации локального кэша.

## TODO

- Рассмотреть возможность добавления retry-механизма для неуспешных синхронизаций
- Добавить метрики для отслеживания эффективности синхронизации
- Оптимизировать загрузку фотографий для больших размеров


# Ежедневные активности (Daily Activities)

Этот документ описывает реализованный функционал ежедневных активностей, устройство локального хранения, офлайн-приоритет и логику сервиса `DailyActivitiesService.swift`.

**Важно**: Этот документ описывает только функционал для типов активностей `stretch`, `rest`, `sick` и комментариев. Функционал создания и редактирования тренировок (тип `workout`) будет описан в отдельной документации.

## Оглавление

- [Краткий обзор функционала](#краткий-обзор-функционала)
- [Компоненты UI](#компоненты-ui)
- [Модель данных: `DayActivity`](#модель-данных-dayactivity)
- [Офлайн-приоритет](#офлайн-приоритет)
- [Сетевая интеграция](#сетевая-интеграция-через-daysclientswclient)
- [Сервис: `DailyActivitiesService`](#сервис-dailyactivitiesservice)
- [UI: взаимодействие и поведение](#ui-взаимодействие-и-поведение)
- [Тестирование и качество](#тестирование-и-качество)
- [Принципы расширения](#принципы-расширения)
- [Ключевые правила](#ключевые-правила)
- [TODO](#todo)

### Краткий обзор функционала

- **Установка активности**: выбор типа активности для дня (stretch, rest, sick) с главного экрана или из дневника.
- **Просмотр активностей**: список и сетка активностей в дневнике с группировкой по секциям программы.
- **Редактирование активности**: изменение типа активности для существующего дня.
- **Комментарии**: добавление, редактирование и удаление комментариев к активностям.
- **Удаление активности**: мягкое удаление с последующей синхронизацией на сервер.
- **Синхронизация**: двунаправленная синхронизация с сервером с разрешением конфликтов по стратегии LWW (Last Write Wins).
- **Навигация**: управление активностью сегодняшнего дня с главного экрана, просмотр всех активностей в дневнике.

### Компоненты UI

- **HomeActivitySectionView** — секция на главном экране для управления активностью сегодняшнего дня.
- **JournalScreen** — основной экран дневника с переключением между списком и сеткой.
- **JournalListView** — список активностей с группировкой по секциям программы.
- **JournalGridView** — сетка активностей с визуализацией дней.
- **DayActivityMenuView** — меню действий для активности (редактирование, комментарий, удаление).
- **DayActivityHeaderMenuView** — заголовок с меню действий для активности в списке.
- **DayActivityContentView** — отображение содержимого активности (тип активности).
- **DayActivityCommentView** — отображение комментария с возможностью развертывания.
- **EditCommentSheet** — модальное окно для редактирования комментария.
- **ActivityRowView** — компонент для отображения простых типов активности (stretch, rest, sick).

### Модель данных: `DayActivity`

- `day: Int` — номер дня (1-100).
- `activityTypeRaw: Int?` — тип активности (rawValue для хранения в SwiftData).
- `count: Int?` — количество кругов/повторений за день (для workout).
- `plannedCount: Int?` — плановое количество повторений (для workout).
- `executeTypeRaw: Int?` — тип выполнения (rawValue для хранения в SwiftData).
- `trainingTypeRaw: Int?` — тип тренировки (rawValue для хранения в SwiftData).
- `duration: Int?` — продолжительность в секундах/минутах.
- `comment: String?` — комментарий пользователя.
- `createDate: Date` — дата создания записи.
- `modifyDate: Date` — дата последнего изменения (используется как источник истины при разрешении конфликтов).
- `isSynced: Bool` — синхронизировано ли состояние с сервером.
- `shouldDelete: Bool` — пометка на удаление (элемент скрывается из UI, удаляется на сервере при следующей синхронизации).
- `user: User?` — связь с пользователем через `@Relationship`.
- `trainings: [DayActivityTraining]` — тренировки этого дня (связь с каскадным удалением).

**Вычисляемые свойства**:

- `activityType: DayActivityType?` — тип активности (преобразование из rawValue).
- `executeType: ExerciseExecutionType?` — тип выполнения упражнений.
- `trainingType: ExerciseType?` — тип тренировки.
- `isPassed: Bool` — пройден ли день (определяется по наличию `count`).
- `activitySnapshot: ActivitySnapshot` — преобразование в снимок для конкурентной синхронизации.
- `dayRequest: DayRequest` — преобразование в запрос для отправки на сервер.
- `workoutData: WorkoutData?` — преобразование в `WorkoutData` для передачи на Apple Watch (только для типа `workout`).

**Методы**:

- `hasDataChanged(comparedTo:) -> Bool` — проверяет, изменились ли данные активности по сравнению с ответом сервера.
- `setNonWorkoutType(_:user:)` — устанавливает тип активности для stretch/rest/sick и очищает тренировочные данные.
- `createNonWorkoutActivity(day:activityType:user:)` — статический метод для создания активности без тренировочных данных.

**Поддерживаемые типы активностей** (для данного функционала):

- `stretch` — растяжка.
- `rest` — отдых.
- `sick` — болезнь.
- `workout` — тренировка (не описывается в этом документе, будет отдельная документация).

### Офлайн-приоритет

- Все операции (создание, обновление, удаление, комментарии) сначала сохраняются локально в SwiftData.
- Синхронизация с сервером выполняется асинхронно, неблокирующе для обычных пользовательских действий.
- При сетевых ошибках работа продолжается локально; состояние помечается как несинхронизированное.
- Конфликты разрешаются автоматически по стратегии LWW (Last Write Wins) на основе поля `modifyDate`.
- Элементы с `shouldDelete == true` скрываются из UI через фильтр `!shouldDelete` в `User.activitiesByDay`.

### Сетевая интеграция (через `DaysClient`/`SWClient`)

- `GET v3/100/days` — получение списка всех активностей пользователя.
- `POST v3/100/days` — создание новой активности (день передается в body).
- `POST v3/100/days/{day}` — обновление существующей активности (используется для создания и обновления).
- `DELETE v3/100/days/{day}` — удаление активности для конкретного дня.

Интерфейс клиента:

- `getDays() async throws -> [DayResponse]`
- `createDay(_ day: DayRequest) async throws -> DayResponse`
- `updateDay(model: DayRequest) async throws -> DayResponse`
- `deleteDay(day: Int) async throws`

Модели запросов/ответов содержат ISO-строки дат (`create_date`, `modify_date`) и поля `activity_type`, `count`, `planned_count`, `execute_type`, `training_type`, `duration`, `comment`, `trainings`.

### Сервис: `DailyActivitiesService`

Сервис помечен `@MainActor` и `@Observable`. Все логи — на русском языке (`OSLog`).

- **Публичные свойства**:
  - `isLoading: Bool` — индикатор общей синхронизации (двунаправленной).
  - `isSyncing: Bool` — индикатор отправки несинхронизированных изменений.

- **Создание**: `createDailyActivity(_:context:)`
  - Проверяет существование активности для дня; если существует — обновляет, иначе создает новую.
  - Устанавливает `isSynced = false` (по умолчанию) и актуальные даты.
  - Привязывает активность к пользователю и trainings к активности.
  - Логи: успешное локальное создание/обновление и указание, что синхронизация выполняется отдельно.

- **Отметка как измененной**: `markDailyActivityAsModified(_:context:) throws`
  - Проставляет `modifyDate = now` и `isSynced = false`, затем сохраняет контекст.
  - Может выбрасывать ошибку при сохранении контекста.
  - Синхронизация изменений выполняется отдельно через `syncDailyActivities(context:)`.

- **Удаление (soft)**: `deleteDailyActivity(_:context:)`
  - Не удаляет объект физически сразу.
  - Ставит `shouldDelete = true`, `isSynced = false`, обновляет `modifyDate` и сохраняет контекст.
  - UI фильтрует такие элементы и не показывает их пользователю.

- **Установка активности**: `set(_:for:context:)`
  - Обрабатывает только типы `stretch`, `rest`, `sick` (для `workout` логирует и возвращается).
  - Если активность существует с тем же типом и не помечена на удаление — пропускает обновление (ранний возврат).
  - Если активность существует с другим типом или помечена на удаление — обновляет тип через `setNonWorkoutType()` (очищает тренировочные данные).
  - Если активности нет — создает новую через `DayActivity.createNonWorkoutActivity()`.
  - Если активность помечена на удаление — снимает флаг и обновляет тип.
  - Сохраняет локально и помечает как несинхронизированную.
  - Логи: успешное создание/обновление активности с указанием типа.

- **Получение активности**: `getActivity(dayNumber:context:) -> DayActivity?`
  - Возвращает активность для указанного дня или `nil`, если активность не найдена или помечена на удаление.
  - Фильтрует активности по пользователю и исключает элементы с `shouldDelete == true`.
  - Используется для получения активности без прямого доступа к `ModelContext`.

- **Получение типа активности**: `getActivityType(day:context:) -> DayActivityType?`
  - Возвращает тип активности для указанного дня или `nil`, если активность не найдена.
  - Использует `getActivity()` для получения активности и возвращает её тип.
  - Используется для быстрой проверки типа активности без загрузки полной модели.

- **Обновление комментария**: `updateComment(day:comment:context:)`
  - Если активность существует — обновляет комментарий, снимает флаг удаления при необходимости.
  - Если активности нет — создает новую активность только с комментарием (без типа активности).
  - Обновляет `modifyDate` и `isSynced = false`.
  - Сохраняет локально и помечает как несинхронизированную.
  - Логи: успешное обновление/создание комментария.

- **Синхронизация несинхронизированных**: `syncUnsyncedActivities(context:) -> (SyncStats, [SyncError], Set<Int>)`
  - Возвращает кортеж: статистику синхронизации, список ошибок и множество удаленных дней.
  - Реализована схема snapshot → group → apply.
  - На этапе snapshot: из `ModelContext` собираются только необходимые неизменяемые данные (`ActivitySnapshot`).
  - На этапе group: параллельно (через `withTaskGroup`) выполняются чистые сетевые операции без доступа к `ModelContext`, для каждого снимка формируется `SyncEvent`:
    - `.createdOrUpdated(day:server)` — сервер вернул актуальную сущность.
    - `.deleted(day)` — сервер подтвердил удаление.
    - `.failed(day:errorDescription)` — ошибка сети/сервера.
  - На этапе apply: все события применяются к `ModelContext` одним проходом на главной очереди:
    - Для `createdOrUpdated` — обновление локальной сущности данными ответа сервера с проверкой дат (LWW), `isSynced = true`, `shouldDelete = false`, даты приводятся из серверных строк.
    - Для `deleted` — запоминание дня для исключения при загрузке с сервера (физическое удаление выполняется в `downloadServerActivities`).
    - Для `failed` — формирование `SyncError` и добавление в список ошибок, локальное состояние сохраняется для последующих повторов.
  - Логи: детальное отслеживание всех этапов синхронизации.

- **Двунаправленная синхронизация**: `syncDailyActivities(context:) async throws -> SyncResult`
  - Возвращает `SyncResult` с детальной информацией о результатах синхронизации (статистика, ошибки).
  - Защита от повторного запуска: выбрасывает `AlreadySyncingError`, если синхронизация уже выполняется.
  - Сначала вызывает `syncUnsyncedActivities` (локальные → сервер) и собирает статистику и ошибки.
  - Затем `downloadServerActivities` (сервер → локальные) с автоматическим разрешением конфликтов по LWW.
  - Ошибки загрузки с сервера также добавляются в список ошибок результата.
  - Формирует `SyncResult` с типом результата (success/partial/error) на основе наличия ошибок и статистики.

- **Загрузка с сервера и LWW**: `downloadServerActivities(context:excludeDeletedDays:)`
  - Загружает все активности пользователя и сопоставляет с локальными по `day`.
  - Порядок проверок для разрешения конфликтов:
    1. Если локальная сущность помечена `shouldDelete` — пропускается обновление (не восстанавливается серверными данными).
    2. Если данные не изменились (`hasDataChanged == false`) и активность синхронизирована — пропускается обновление.
    3. Если локальная активность имеет несинхронизированные изменения (`isSynced = false`) — пропускается обновление с сервера (локальные изменения имеют приоритет).
    4. Сравнение дат для синхронизированных активностей с измененными данными:
       - Если `local.modifyDate > server.modify_date` — сохраняется локальная версия (локальная версия новее).
       - Если `server.modify_date > local.modifyDate` — локальная сущность обновляется по данным сервера и помечается синхронизированной.
  - Для синхронизированных элементов, отсутствующих на сервере, — выполняется физическое удаление локального объекта.
  - Для элементов, удаленных в текущем цикле синхронизации, — выполняется физическое удаление при подтверждении сервером.
  - Логи: детальное отслеживание разрешения конфликтов с временными метками для сравнения дат.

- **Логирование (все сообщения на русском)**:
  - Старт/завершение синхронизаций, количество элементов к синку.
  - Подробности запросов при отправке (day, activity_type, count, даты).
  - Результаты применения: «обновлено локально», «удалено локально», «пропущено (локальная версия новее)».
  - Ошибки сети/применения с `error.localizedDescription` и деталями `APIError`, если доступен.
  - Детальное логирование разрешения конфликтов с временными метками для сравнения дат.

### UI: взаимодействие и поведение

- **Главный экран** (`HomeActivitySectionView`):
  - Отображается только если `currentDay <= 100`.
  - Показывает текущую активность дня (если есть) через `DayActivityContentView`.
  - Показывает комментарий через `DayActivityCommentView`.
  - Меню действий через `DayActivityMenuView` (редактирование, комментарий, удаление).
  - Если активности нет — показывает кнопки выбора типа активности (stretch, rest, sick, workout).
  - Для workout показывает только логирование (TODO).
  - Анимация переходов при изменении активности.
  - Диалог подтверждения при удалении активности.
  - Модальное окно для редактирования комментария.

- **Экран дневника** (`JournalScreen`):
  - Переключение между списком и сеткой через `Picker` в toolbar.
  - Кнопка сортировки (только для списка) с выбором направления (forward/reverse).
  - Сохранение выбранного режима отображения в `AppStorage`.

- **Список активностей** (`JournalListView`):
  - Группировка по секциям программы (Подготовка, Базовый блок, Продвинутый блок, Турбо блок, Заключение).
  - Каждая активность отображается в виде:
    - Заголовок с меню действий через `DayActivityHeaderMenuView`.
    - Содержимое активности через `DayActivityContentView`.
    - Комментарий через `DayActivityCommentView` (если есть).
  - Дни, которые еще не начались (`day > currentDay`), отключаются для редактирования.
  - Диалог подтверждения при удалении активности.
  - Модальное окно для редактирования комментария.

- **Сетка активностей** (`JournalGridView`):
  - Отображение дней в виде сетки с цветовой индикацией типа активности.
  - Текущий день выделяется рамкой.
  - Дни, которые еще не начались, отображаются с пониженной непрозрачностью.
  - Меню действий при нажатии на день через `DayActivityMenuView`.
  - Диалог подтверждения при удалении активности.
  - Модальное окно для редактирования комментария.

- **Редактирование комментария** (`EditCommentSheet`):
  - Модальное окно с заголовком "Комментарий".
  - Многострочный редактор текста (`SWTextEditor`) с автоматическим открытием клавиатуры.
  - Плейсхолдер "Опишите этот день…".
  - Кнопка "Сохранить" с проверкой наличия изменений.
  - Binding напрямую к `activity.comment` через computed property.
  - При сохранении вызывает `activitiesService.updateComment()`.
  - Офлайн-приоритет: сохранение локально, синхронизация отдельно.

- **Отображение комментария** (`DayActivityCommentView`):
  - Показывается только если комментарий не пустой.
  - Ограничение до 3 строк с возможностью развертывания при нажатии.
  - Анимация развертывания/сворачивания.
  - Возможность выделения текста.

- **Меню действий** (`DayActivityMenuView`):
  - Если активности нет — показывает варианты создания (все типы активностей).
  - Если активность есть:
    - Для workout — кнопка "Редактировать" (TODO).
    - Для других типов — подменю "Редактировать" с выбором другого типа.
    - Кнопка "Комментарий" (открывает `EditCommentSheet`).
    - Кнопка "Удалить" (открывает диалог подтверждения).

### Тестирование и качество

- Unit-тесты для `DailyActivitiesService` (39 тестов) — проверка создания, обновления, удаления, установки типа активности, обновления комментария, синхронизации.
- Unit-тесты для синхронизации — проверка успешной синхронизации, параллельной отправки, обработки конфликтов, удаления.
- Проверки локализации пользовательских строк и корректности логов (на русском).

### Принципы расширения

- Новые поля в `DayActivity` добавлять с учетом мягких миграций SwiftData.
- Для новых операций соблюдать офлайн-приоритет: локальные изменения в первую очередь, синхронизация — отдельно и неблокирующе.
- Все сетевые операции — через абстракции клиентов (`DaysClient`), без прямых вызовов внутри View.
- Поддержка новых типов активностей через расширение `DayActivityType` (кроме workout, который требует отдельной реализации).

### Ключевые правила

- Не блокировать UI ожиданием сети в экранах активностей.
- Всегда писать логи на русском с достаточным контекстом.
- Разрешать конфликты автоматически по `modifyDate` (LWW).
- Soft delete: сначала пометка и скрытие в UI, потом удаление на сервере и физическое удаление локально.
- При установке типа активности через `set()` очищать все тренировочные данные для stretch/rest/sick.
- Комментарий может существовать без типа активности (для возможности добавления комментария к дню без активности).
- Фильтровать элементы с `shouldDelete == true` из отображения через `User.activitiesByDay`.
- Для workout использовать отдельный функционал редактирования тренировок (не описывается в этом документе).

## TODO

- Рассмотреть возможность добавления retry-механизма для неуспешных синхронизаций
- Добавить метрики для отслеживания эффективности синхронизации

# Публикация приложения

## Сборки в TestFlight

Сборки в `TestFlight` публикуются командой:
```shell
make testflight
```
Под капотом используется `fastlane` (см. настройки в [Fastfile](../fastlane/Fastfile)).

### Ручная отправка в TestFlight
1. Скачать актуальную версию репозитория
   - Если ранее не скачивал, можно скачать по зеленой кнопке сверху с текстом `Code -> Open with Xcode`
   - Если ранее скачивал, то открываешь `Xcode`, в верхней панели нажать `Source Control -> Pull`
2. Открыть `Xcode` и дождаться загрузки зависимостей; при возникновении ошибок можно:
   -  почистить `Derived Data` и память билда (`command + shift + k`)
   -  обновить зависимости (`File -> Packages -> Reset/Resolve/Update`)
3. В верхней панели Xcode сменить девайс на `Any iOS Device`
4. В верхней панели нажать `Product -> Archive`
5. Дождаться архивации, в открывшемся окне со сборками выбрать нужную и нажать **Distribute App**
6. Пройти по всем шагам и снять галку с автоматического изменения версии сборки на одном из финальных шагов

## AppStore
1. Открыть страницу с приложением в **appstoreconnect.apple.com**
2. В левом меню рядом с версией в статусе **Готово к продаже** нажать `+` и добавить новую версию
3. Заполнить поле **Что нового в этой версии** для русского и английского языков
4. Ниже в разделе **Сборка** выбрать нужную сборку из `TestFlight`
5. Ниже на странице проверить галки
   - *Выпустить эту версию автоматически*
   - *Выпустить обновление сразу для всех пользователей*
   - *Сохранить текущую оценку*
6. Нажать сверху справа кнопку **Сохранить**
7. Отправить приложение на проверку

## Скриншоты

1. Генерируем скриншоты при помощи `Fastlane` ([документация](https://docs.fastlane.tools/getting-started/ios/setup/))
2. Настройки для генерации скриншотов находятся в [Snapfile](../fastlane/Snapfile) ([документация](https://docs.fastlane.tools/actions/snapshot/))
3. Для генерации скриншотов нужно предварительно [настроить проект](setup-guide.md)
4. Генерация скриншотов выполняется командой:
```shell
make screenshots
```
5. Для генерации скриншотов **необходимо наличие в Xcode симуляторов с нужной версией iOS** в соответствие с настройками в [Snapfile](../fastlane/Snapfile)
6. Если тесты падают с ошибкой при запуске через `fastlane`, нужно убедиться, что при ручном запуске тестов из `Xcode` они успешно проходят во всех локализациях, используемых для создания скриншотов
7. Готовые скриншоты сохраняются в папке [screenshots](../fastlane/screenshots)
8. Отправить скриншоты в appstoreconnect можно командой:
```shell
make upload_screenshots
```

### Модели девайсов, используемые для скриншотов
По состоянию на 2025 год Apple берет за основу скриншоты для диагонали 6.9 (или 6.7) дюймов для айфона (13 дюймов для айпада) и масштабирует их под все остальные размеры экранов, то есть можно использовать для скриншотов по одному девайсу на платформу:
- iPhone 15 Pro Max
- iPad Pro (12.9-inch) (6th generation)

Список всех существующих девайсов есть [тут](https://iosref.com/res).

# Экран инфопостов (Infoposts)

Этот документ описывает реализованный функционал экрана инфопостов, устройство локального хранения, офлайн-приоритет и логику сервиса `InfopostsService.swift`.

## Оглавление

- [Краткий обзор функционала](#краткий-обзор-функционала)
- [Модель данных: `Infopost`](#модель-данных-infopost)
- [Офлайн-приоритет](#офлайн-приоритет)
- [Сетевая интеграция (через `InfopostsClient`/`SWClient`)](#сетевая-интеграция-через-infopostsclientswclient)
- [Сервис: `InfopostsService`](#сервис-infopostsservice)
- [UI: взаимодействие и поведение](#ui-взаимодействие-и-поведение)
- [Тестирование и качество](#тестирование-и-качество)
- [Принципы расширения](#принципы-расширения)
- [Ключевые правила](#ключевые-правила)
- [TODO](#todo)

### Краткий обзор функционала

- **Список инфопостов**: отображение инфопостов с группировкой по секциям (Подготовка, Базовый блок, Продвинутый блок, Турбо блок, Заключение).
- **Режимы отображения**: переключение между всеми постами и избранными.
- **Фильтрация**: по полу пользователя и доступности по текущему дню программы.
- **Избранное**: добавление/удаление инфопостов в избранное с локальным сохранением.
- **Сворачивание секций**: возможность сворачивать/разворачивать секции для удобной навигации.
- **Просмотр контента**: полноценное отображение HTML с поддержкой CSS/JS, темной темы и размера шрифта.
- **YouTube интеграция**: автоматическое добавление видео для соответствующих дней.
- **Статистика прочитанных**: отслеживание прочитанных постов с синхронизацией на сервер.
- **Навигация**: переходы список → детальный просмотр с сохранением состояния.

### Модель данных: `Infopost`

- `id: String` — уникальный идентификатор (например, "d1", "d50", "aims", "organiz").
- `title: String` — заголовок инфопоста, извлекаемый из HTML.
- `content: String` — HTML содержимое с обработанными путями к изображениям.
- `section: InfopostSection` — секция (Preparation, Base, Advanced, Turbo, Conclusion).
- `dayNumber: Int?` — номер дня для постов с номерами (nil для специальных постов).
- `language: String` — язык инфопоста ("ru" или "en").
- `gender: Gender?` — пол, для которого предназначен пост (nil для универсальных).
- `isFavoriteAvailable: Bool` — доступность функции избранного (false для поста "about").

### Офлайн-приоритет

- Все HTML файлы хранятся локально в бандле приложения (104 файла + изображения).
- Статистика прочитанных постов сохраняется локально в SwiftData.
- Синхронизация с сервером выполняется асинхронно, неблокирующе для пользователя.
- При сетевых ошибках работа продолжается локально; состояние помечается как несинхронизированное.
- Несинхронизированные дни (`unsyncedReadInfopostDays`) в модели `User` для последующей синхронизации.

### Сетевая интеграция (через `InfopostsClient`/`SWClient`)

- `GET v3/100/posts/read` — получение списка прочитанных постов.
- `POST v3/100/posts/read/<day>` — отметка поста как прочитанного.
- `DELETE v3/100/posts/read` — удаление всех прочитанных постов (для тестов).

Интерфейс клиента:

- `getReadPosts() async throws -> [Int]`
- `setPostRead(day: Int) async throws`
- `deleteAllReadPosts() async throws`

### Сервис: `InfopostsService`

Сервис помечен `@MainActor` и `@Observable`. Все логи — на русском языке (`OSLog`).

- **Публичные свойства**:
  - `displayMode: InfopostsDisplayMode` — режим отображения (все/избранные).
  - `sectionsForDisplay: [InfopostSectionDisplay]` — секции для отображения с состоянием сворачивания.
  - `showDisplayModePicker: Bool` — показывать ли переключатель режимов.
  - `todayInfopost: Infopost?` — инфопост для текущего дня (загружается через `loadTodayInfopost`).

- **Загрузка инфопостов**: `loadAvailableInfoposts(currentDay:maxReadInfoPostDay:userGender:force:)`
  - Загружает и фильтрует инфопосты по доступности и полу пользователя.
  - Использует кэширование инфопостов (`cachedInfoposts`) для оптимизации производительности: при повторных вызовах использует кэшированные данные вместо повторного парсинга файлов.
  - Пропускает загрузку, если инфопосты уже загружены (если не установлен флаг `force`).
  - Учитывает текущий день программы и максимальный доступный день с сервера через `InfopostAvailabilityManager`.

- **Управление избранным**: `isFavorite(_:modelContext:)`, `changeFavorite(id:modelContext:)`, `loadFavoriteIds(modelContext:)`
  - Проверяет и изменяет статус избранного для инфопостов.
  - Загружает список избранных инфопостов из базы данных.
  - Сохраняет изменения в SwiftData и обновляет локальное состояние.

- **Синхронизация прочитанных**: `syncReadPosts(context:)`
  - Загружает прочитанные дни с сервера и обновляет локальные данные.
  - Параллельно отправляет несинхронизированные дни на сервер с использованием `TaskGroup`.
  - Перемещает успешно синхронизированные дни из несинхронизированных в синхронизированные.
  - Обрабатывает ошибки сети с graceful degradation - неуспешные дни остаются в несинхронизированных.

- **Отметка как прочитанного**: `markPostAsRead(day:modelContext:)`
  - Принимает опциональный `day: Int?` (игнорирует nil).
  - Помечает пост как прочитанный локально.
  - Пытается синхронизировать с сервером асинхронно.
  - Сохраняет несинхронизированные дни для последующих попыток.
  - При успешной синхронизации перемещает день из несинхронизированных в синхронизированные.

- **Проверка статуса прочитанного**: `isPostRead(_:modelContext:)`
  - Проверяет, прочитан ли инфопост (учитывает синхронизированные и несинхронизированные дни).
  - Выбрасывает `ServiceError.infopostCannotBeMarkedAsRead`, если инфопост не имеет номера дня.

- **Загрузка инфопоста для текущего дня**: `loadTodayInfopost(for:)`
  - Загружает инфопост для указанного дня и сохраняет в `todayInfopost`.
  - Выбрасывает `ServiceError.infopostNotFound`, если инфопост не найден.

- **Загрузка инфопоста "about"**: `loadAboutInfopost()`
  - Загружает инфопост "about" напрямую из файла, минуя `filenameManager`.
  - Возвращает `Infopost?` (nil, если не найден).

- **Управление секциями**: `didTapSection(_:)`
  - Обрабатывает сворачивание/разворачивание секций.
  - Сохраняет состояние в памяти для текущей сессии.

- **Очистка состояния**: `didLogout()`
  - Сбрасывает все состояние сервиса при выходе пользователя.
  - Очищает избранное, доступные инфопосты, состояние секций.

- **Логирование (все сообщения на русском)**:
  - Загрузка и фильтрация инфопостов.
  - Изменения статуса избранного.
  - Синхронизация прочитанных постов с детализацией успешных/неуспешных операций.
  - Ошибки сети и обработки данных.

- **Обработка ошибок**:
  - `ServiceError.userNotFound` - пользователь не найден в базе данных.
  - `ServiceError.infopostNotFound(day: Int)` - инфопост для указанного дня не найден.
  - `ServiceError.parsingError` - ошибка при парсинге HTML файлов инфопостов.
  - `ServiceError.infopostCannotBeMarkedAsRead` - инфопост не может быть отмечен как прочитанный (нет номера дня).

### UI: взаимодействие и поведение

- **Список инфопостов**: группировка по секциям с возможностью сворачивания.
- **Индикатор непрочитанных**: круглая точка (8dp) слева от заголовка для непрочитанных инфопостов с номером дня, аналогично Android-SOTKA.
- **Детальный просмотр**: WKWebView с поддержкой HTML, CSS, JavaScript.
- **Настройки отображения**: выбор размера шрифта и автоматическая темная тема.
- **YouTube интеграция**: автоматическое добавление видео для соответствующих дней.
- **Отслеживание прочтения**: JavaScript скрипт отслеживает достижение места добавления видео.
- **Избранное**: кнопка в навбаре для добавления/удаления из избранного.

### Тестирование и качество

- Unit-тесты для `InfopostsService` (15 тестов) — проверка загрузки, фильтрации, избранного.
- Unit-тесты для `InfopostsServiceSyncTests` — проверка синхронизации прочитанных постов, включая:
  - Успешную синхронизацию с сервером.
  - Параллельную отправку несинхронизированных дней.
  - Обработку частичных сбоев синхронизации.
  - Проверку статуса прочитанных постов.
- Unit-тесты для `InfopostParser` (14 тестов) — проверка парсинга HTML файлов.
- Unit-тесты для `InfopostSectionDisplay` (8 тестов) — проверка модели отображения секций.
- Проверки локализации пользовательских строк и корректности логов (на русском).

### Принципы расширения

- Новые секции добавлять в `InfopostSection` с соответствующими локализованными заголовками.
- Для новых типов контента соблюдать офлайн-приоритет: локальное хранение в первую очередь.
- Все сетевые операции — через абстракции клиентов (`InfopostsClient`), без прямых вызовов внутри View.
- Поддержка новых языков через добавление файлов в соответствующие папки.

### Ключевые правила

- Не блокировать UI ожиданием сети в экране инфопостов.
- Всегда писать логи на русском с достаточным контекстом.
- Обеспечивать работу без интернета для всех основных функций.
- Фильтровать контент по полу пользователя и доступности по дням программы.
- Синхронизировать статистику прочитанных асинхронно и неблокирующе.
- Показывать индикатор непрочитанных только для доступных инфопостов с номером дня.
- Индикатор скрывается сразу после отметки инфопоста как прочитанного.

## TODO

- Рассмотреть возможность добавления retry-механизма для неуспешных синхронизаций
- Добавить метрики для отслеживания эффективности синхронизации

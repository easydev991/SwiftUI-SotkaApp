# Экран тренировки (Workout Screen)

Этот документ описывает реализованный функционал экрана тренировки, устройство управления состоянием тренировки, логику таймера отдыха и обработку завершения тренировки через ViewModel `WorkoutScreenViewModel.swift`.

## Оглавление

- [Краткий обзор функционала](#краткий-обзор-функционала)
- [Компоненты UI](#компоненты-ui)
- [Модели данных](#модели-данных)
- [ViewModel: WorkoutScreenViewModel](#viewmodel-workoutscreenviewmodel)
- [UI: взаимодействие и поведение](#ui-взаимодействие-и-поведение)
- [Интеграция с другими экранами](#интеграция-с-другими-экранами)
- [Уведомления и звук/вибрация](#уведомления-и-звуквибрация)
- [Тестирование и качество](#тестирование-и-качество)
- [Принципы расширения](#принципы-расширения)
- [Ключевые правила](#ключевые-правила)

### Краткий обзор функционала

- **Пошаговое выполнение тренировки**: отображение этапов тренировки (разминка, упражнения, заминка) с возможностью завершения каждого этапа.
- **Типы выполнения**: поддержка типов выполнения `.cycles` (круги), `.sets` (подходы) и `.turbo` (турбо-дни) с автоматическим определением фактического типа для турбо-дней.
- **Таймер отдыха**: показ таймера отдыха между этапами (кроме разминки и перед заминкой) с уведомлениями и звуком/вибрацией.
- **Прерывание тренировки**: возможность прервать тренировку в любой момент с подтверждением через диалог.
- **Отслеживание времени**: автоматический подсчет длительности тренировки и фактического времени отдыха.
- **Навигация**: переход из экрана превью тренировки с возвратом результата через замыкание.

### Компоненты UI

- **WorkoutScreen** — основной экран тренировки с отображением этапов и управлением тренировкой.
- **WorkoutTimerScreen** — полноэкранный таймер отдыха с круговой анимацией и кнопкой завершения.
- **WorkoutRowView** — компонент строки этапа с отображением состояния (активный, завершенный, не начатый) и кнопкой завершения.
- **CircularTimerView** — компонент кругового таймера с анимацией обратного отсчета и отображением времени в формате MM:SS.

### Модели данных

#### WorkoutStep

Enum для представления этапа тренировки:

- `case warmUp` — разминка.
- `case exercise(ExerciseExecutionType, number: Int)` — упражнение (круг/подход) с типом выполнения и номером.
- `case coolDown` — заминка.

#### WorkoutState

Enum для представления состояния этапа:

- `case active` — текущий активный этап (пользователь должен выполнить этот этап).
- `case completed` — завершенный этап (отображается с галочкой).
- `case inactive` — еще не начатый этап (отображается без действий).

#### WorkoutStepState

Структура для хранения этапа и его состояния:

- `step: WorkoutStep` — этап тренировки.
- `state: WorkoutState` — состояние этапа.
- `id: String` — уникальный идентификатор (вычисляется из `step.id`).

#### WorkoutResult

Структура для возврата результата тренировки:

- `count: Int` — количество выполненных кругов/подходов (для прерванной тренировки — только завершенные упражнения).
- `duration: Int?` — длительность тренировки в секундах (время выполнения + фактическое время отдыха).

### ViewModel: WorkoutScreenViewModel

ViewModel помечен `@MainActor` и `@Observable`. Все логи — на русском языке (`OSLog`).

**Публичные свойства**:
- `dayNumber: Int` — номер дня программы.
- `executionType: ExerciseExecutionType` — тип выполнения тренировки (`.cycles`, `.sets`, `.turbo`).
- `trainings: [WorkoutPreviewTraining]` — список упражнений тренировки.
- `plannedCount: Int?` — запланированное количество кругов/подходов.
- `restTime: Int` — время отдыха между подходами/кругами (в секундах).
- `stepStates: [WorkoutStepState]` — массив этапов тренировки с их состояниями.
- `currentStepIndex: Int` — индекс текущего активного этапа.
- `showTimer: Bool` — флаг показа таймера отдыха.
- `currentStep: WorkoutStep?` — вычисляемое свойство текущего активного этапа.
- `isWorkoutCompleted: Bool` — вычисляемое свойство завершенности тренировки (все этапы завершены).
- `shouldShowExercisesReminder: Bool` — вычисляемое свойство для отображения секции со списком упражнений (для `.cycles` и турбо-дней с кругами).
- `isTurboWithSets: Bool` — вычисляемое свойство для определения, является ли текущая тренировка турбо-днем с подходами (дни 93, 95, 98).

**Инициализация**: `setupWorkoutData(dayNumber:executionType:trainings:plannedCount:restTime:)`
- Настраивает данные тренировки из переданных параметров.
- Вызывает `initializeStepStates()` для создания этапов.
- Устанавливает первый этап как активный.
- Инициализирует `workoutStartTime` для отслеживания длительности.
- Логи: настройка данных тренировки с указанием дня и типа выполнения.

**Инициализация этапов**: `initializeStepStates()`
- Создает этапы в зависимости от фактического типа выполнения (определяется через `getEffectiveExecutionType()`).
- Для `.cycles`: создает разминку, круги (по количеству `plannedCount`), заминку.
- Для `.sets`: создает разминку, подходы для каждого упражнения:
  - Для турбо-дней с подходами (определяется через вычисляемое свойство `isTurboWithSets`): 1 подход на упражнение.
  - Для остальных: по количеству `plannedCount` подходов на каждое упражнение.
  - Номера подходов повторяются для каждого упражнения (1, 2, 3... для первого упражнения, затем снова 1, 2, 3... для второго упражнения).
- Для турбо-дней использует фактический тип выполнения (`.cycles` или `.sets`) в зависимости от номера дня.
- Логи: инициализация этапов с указанием типа выполнения и количества.

**Определение фактического типа выполнения**: `getEffectiveExecutionType() -> ExerciseExecutionType`
- Делегирует определение в `WorkoutProgramCreator.getEffectiveExecutionType(for:executionType:)`.
- Для турбо-дней определяет фактический тип выполнения по номеру дня:
  - Дни 93, 95, 98 → `.sets` (подходы).
  - Дни 92, 94, 96, 97 → `.cycles` (круги).
- Для остальных типов возвращает исходный тип без изменений.

**Завершение этапа**: `completeCurrentStep(appSettings:)`
- Помечает текущий этап как завершенный.
- Переходит к следующему этапу.
- Определяет, нужно ли показывать таймер отдыха:
  - Не показывается после разминки (сразу переходит к первому упражнению).
  - Не показывается перед заминкой (сразу переходит к заминке).
  - Показывается после всех остальных этапов.
- При показе таймера сохраняет `currentRestStartTime` для отслеживания фактического времени отдыха.
- Планирует уведомление о завершении отдыха через `scheduleRestTimerNotification(appSettings:)`.
- Логи: завершение этапа с указанием типа и номера.

**Обработка завершения таймера**: `handleTimerFinish(force:appSettings:)`
- Проверяет, что `currentRestStartTime != nil` (защита от повторных вызовов), иначе возвращается.
- Отменяет уведомление о завершении отдыха.
- Закрывает экран таймера (`showTimer = false`).
- Вычисляет фактическое время отдыха и добавляет его к `totalRestTime`.
- Обнуляет `currentRestStartTime` для предотвращения повторной обработки.
- Активирует следующий этап (если он есть).
- Воспроизводит звук и вибрацию (если `force == false`):
  - Звук: выбранный звук из `appSettings.timerSound` через `AudioPlayerManager` (если `appSettings.playTimerSound == true`).
  - Вибрация: через `VibrationService.perform()` (если `appSettings.vibrate == true`).
- Логи: завершение таймера отдыха с указанием фактического времени.

**Планирование уведомления**: `scheduleRestTimerNotification(appSettings:)`
- Отменяет предыдущее уведомление (если есть).
- Создает уведомление с заголовком "SOTKA" и телом "Отдых завершён - продолжаем!".
- Использует стандартный звук `.default` в уведомлении (если `appSettings.playTimerSound == true`).
- Планирует уведомление через `restTime` секунд.
- Логи: планирование уведомления с указанием времени.

**Отмена уведомления**: `cancelRestTimerNotification()`
- Удаляет запланированное уведомление о завершении отдыха.
- Логи: отмена уведомления.

**Проверка истекшего таймера**: `checkAndHandleExpiredRestTimer(appSettings:)`
- Проверяет, что таймер показывается и время начала отдыха установлено.
- Вычисляет прошедшее время с момента начала отдыха.
- Если таймер истек, вызывает `handleTimerFinish(force:true, appSettings:)` для закрытия таймера без звука и вибрации.
- Используется при активации приложения (когда пользователь открывает приложение по уведомлению).
- Логи: обнаружение истекшего таймера при активации приложения.

**Получение результата тренировки**: `getWorkoutResult(interrupt:) -> WorkoutResult?`
- Отменяет уведомление о завершении отдыха.
- Если `interrupt == false`: проверяет, что тренировка завершена (`isWorkoutCompleted`), иначе возвращает `nil`.
- Если `interrupt == true`: возвращает результат даже для незавершенной тренировки.
- Подсчитывает количество выполненных упражнений (кругов/подходов):
  - Для обычного завершения: общее количество этапов упражнений.
  - Для прерванной тренировки:
    - Для типа выполнения `.sets` (подходы): возвращает `plannedCount` (запланированное количество подходов).
    - Для типа выполнения `.cycles` (круги): возвращает количество завершенных этапов упражнений.
- Вычисляет длительность тренировки:
  - Время выполнения: `Date().timeIntervalSince(workoutStartTime)`.
  - Общая длительность: время выполнения + `totalRestTime` (сумма фактического времени всех отдыхов).
- Логи: получение результата тренировки с указанием количества и длительности (различает прерванные и завершенные тренировки).

**Вспомогательные методы**:
- `getStepState(for:) -> WorkoutState` — возвращает состояние для конкретного этапа.
- `getCycleSteps() -> [WorkoutStepState]` — возвращает круги для типа выполнения `.cycles` (включая турбо-дни с кругами).
- `getExerciseSteps(for:) -> [WorkoutStepState]` — возвращает подходы для конкретного упражнения (для типа выполнения `.sets`).
- `getExerciseTitle(for:modelContext:) -> String` — возвращает название упражнения.
- `getExerciseTitleWithCount(for:modelContext:) -> String` — возвращает название упражнения с количеством повторений.

**Логирование (все сообщения на русском)**:
- Настройка данных тренировки с указанием дня и типа выполнения.
- Инициализация этапов с указанием типа выполнения и количества.
- Завершение этапов с указанием типа и номера.
- Завершение таймера отдыха с указанием фактического времени.
- Планирование и отмена уведомлений о завершении отдыха.
- Получение результата тренировки с указанием количества и длительности.
- Обнаружение истекшего таймера при активации приложения.

### UI: взаимодействие и поведение

**Экран тренировки** (`WorkoutScreen`):
- Отображает список этапов тренировки с возможностью завершения каждого этапа.
- Секции экрана:
  - `exercisesReminderSection` — список упражнений как напоминалка (только для `.cycles` и турбо-дней с кругами).
  - `warmUpSection` — этап разминки с кнопкой завершения.
  - `workoutStepsSection` — этапы тренировки (круги или подходы):
    - Для `.cycles`: отображает круги в виде списка.
    - Для `.sets`: отображает подходы, сгруппированные по упражнениям с заголовками.
  - `coolDownSection` — этап заминки с обработкой завершения тренировки.
  - `stopWorkoutButtonSection` — кнопка "Прервать тренировку" с подтверждением через диалог.
- Отслеживает `scenePhase` для обработки истекшего таймера при активации приложения.
- Показывает `WorkoutTimerScreen` через `fullScreenCover` при `showTimer == true`.
- При завершении заминки вызывает `getWorkoutResult()` и передает результат через `onWorkoutCompleted`.
- При прерывании тренировки вызывает `getWorkoutResult(interrupt:true)` и передает результат через `onWorkoutCompleted`.

**Экран таймера отдыха** (`WorkoutTimerScreen`):
- Полноэкранный экран с круговым таймером и кнопкой завершения.
- Отображает оставшееся время в формате MM:SS.
- Обрабатывает сворачивание/разворачивание приложения:
  - При сворачивании сохраняет время паузы.
  - При разворачивании вычисляет правильное оставшееся время на основе реального прошедшего времени.
  - Отключает анимацию при разворачивании для предотвращения ускоренной анимации.
- Автоматически закрывается при достижении 0 секунд с задержкой 1 секунда перед вызовом `onFinish(false)`.
- Кнопка "Завершить" позволяет досрочно завершить отдых (вызывает `onFinish(true)`).

**Компонент строки этапа** (`WorkoutRowView`):
- Отображает название этапа и его состояние.
- Для активного этапа показывает текст "В процессе" рядом с названием и кнопку "Готово" для завершения.
- Для завершенного этапа показывает галочку.
- Для не начатого этапа не показывает действий.

**Компонент кругового таймера** (`CircularTimerView`):
- Отображает круговой прогресс-бар с анимацией обратного отсчета.
- Показывает оставшееся время в формате MM:SS с моноширинным шрифтом.
- Поддерживает отключение анимации для предотвращения ускоренной анимации при разворачивании приложения.

### Интеграция с другими экранами

**Переход из WorkoutPreviewScreen**:
- Переход к экрану тренировки происходит через `fullScreenCover` с передачей параметров тренировки:
  - `dayNumber`, `executionType`, `trainings`, `plannedCount`, `restTime`.
- Замыкание `onWorkoutCompleted` обрабатывает результат тренировки через `viewModel.handleWorkoutResult(result)`.

**Возврат после завершения тренировки**:
- После завершения тренировки (через заминку или прерывание) данные возвращаются на `WorkoutPreviewScreen` через замыкание `onWorkoutCompleted` с результатом тренировки (`WorkoutResult`).
- Экран `WorkoutPreviewScreen` обрабатывает результат через `handleWorkoutResult()`:
  - Если `result.count == 0`: не обновляет состояние (позволяет пользователю снова начать тренировку).
  - Если `result.count > 0`: устанавливает `isWorkoutCompleted = true`, обновляет `count` и `workoutDuration` для отображения формы сохранения.

### Уведомления и звук/вибрация

**Структура уведомления о завершении отдыха**:
- Заголовок: "SOTKA" (из локализации `.notificationDailyWorkoutTitle`).
- Тело: "Отдых завершён - продолжаем!" (из локализации `.restCompleted`).
- Звук: стандартный звук `.default` (если `appSettings.playTimerSound == true`).
- Идентификатор: `"restTimerNotification"` для возможности отмены.

**Логика звука и вибрации**:
- **Если приложение свернуто** при срабатывании уведомления:
  - Звук: стандартный звук `.default` через уведомление (если `appSettings.playTimerSound == true`).
  - Вибрация: автоматически через уведомление (если звук включен, вибрация происходит автоматически в iOS).
- **Если приложение открыто** и таймер закончился на экране:
  - Звук: выбранный звук из `appSettings.timerSound` через `AudioPlayerManager` (если `appSettings.playTimerSound == true`).
  - Вибрация: через `VibrationService.perform()` (если `appSettings.vibrate == true`).
- **При открытии приложения по нажатию на уведомление**:
  - Звук: НЕ воспроизводится (пользователь уже получил уведомление).
  - Вибрация: НЕ выполняется (пользователь уже получил уведомление).

### Тестирование и качество

- Unit-тесты для `WorkoutScreenViewModel` — проверка инициализации данных, инициализации этапов, завершения этапов, обработки таймера, получения результата тренировки, вспомогательных методов.
- Unit-тесты для турбо-дней — проверка определения фактического типа выполнения, инициализации этапов, фильтрации кругов/подходов для всех турбо-дней (92-98).
- Unit-тесты для прерывания тренировки — проверка получения результата прерванной тренировки с различными сценариями.
- Проверки локализации пользовательских строк и корректности логов (на русском).

### Принципы расширения

- Новые типы выполнения добавлять в `ExerciseExecutionType` с соответствующей логикой в `WorkoutScreenViewModel` и `WorkoutProgramCreator`.
- Для новых блоков программы соблюдать офлайн-приоритет: все данные локально, синхронизация — отдельно и неблокирующе.
- ViewModel не должна хранить ссылки на `ModelContext` или сервисы — они передаются в методы как параметры. Это упрощает тестирование и делает зависимости явными.
- ViewModel не занимается сохранением тренировки — данные возвращаются через замыкание `onWorkoutCompleted` для обработки на экране превью.

### Ключевые правила

- Не блокировать UI ожиданием сети в экране тренировки (сеть не используется).
- Всегда писать логи на русском с достаточным контекстом.
- Таймер отдыха не показывается после разминки и перед заминкой.
- Состояние следующего этапа обновляется после завершения таймера в `handleTimerFinish()`, кроме заминки (устанавливается сразу).
- Длительность тренировки: (время окончания - время начала) + сумма фактического времени всех отдыхов.
- Фактическое время отдыха засекается в момент закрытия `WorkoutTimerScreen` (в `handleTimerFinish`).
- Метод `handleTimerFinish` защищен от повторных вызовов проверкой `currentRestStartTime != nil`.
- `WorkoutTimerScreen` показывается через `fullScreenCover`.
- Уведомление о завершении отдыха планируется при показе таймера и отменяется при закрытии.
- При прерывании тренировки отменяется уведомление о таймере отдыха.
- Для турбо-дней фактический тип выполнения определяется через `WorkoutProgramCreator.getEffectiveExecutionType()` по номеру дня, а не по `executionType`.
- Секция со списком упражнений показывается для `.cycles` и для турбо-дней с кругами (92, 94, 96, 97), но не показывается для `.sets` и для турбо-дней с подходами (93, 95, 98).
- При открытии приложения по уведомлению звук и вибрация НЕ воспроизводятся (пользователь уже получил уведомление).
- `AppSettings` передается из environment View в методы ViewModel.

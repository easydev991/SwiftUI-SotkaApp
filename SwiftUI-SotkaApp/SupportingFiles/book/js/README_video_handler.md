# Универсальный обработчик видео для инфопостов

## Описание

`video_handler.js` - это универсальный JavaScript скрипт, который обеспечивает обработку всех видео в инфопостах с таймаутом загрузки и кнопкой перезагрузки.

## Функциональность

### Автоматическая обработка видео
- **YouTube видео**: iframe с `youtube.com`, `youtu.be`
- **Vimeo видео**: iframe с `vimeo.com`
- **HTML5 видео**: теги `<video>`
- **Другие плееры**: iframe с `player` в src

### Обработка ошибок
- **Таймаут загрузки**: 10 секунд
- **Проверка интернета**: `navigator.onLine`
- **Кнопка перезагрузки**: с красивым дизайном
- **Логирование**: в консоль браузера

### Уникальные ID
- Автоматическая генерация уникальных ID для видео
- Основана на src, индексе элемента и родительском контейнере

## Использование

### Автоматическое подключение
Скрипт автоматически подключается в `InfopostParser.swift` через функцию `addUniversalVideoHandler()`.

### Ручное подключение
```html
<script type="text/javascript" src="js/video_handler.js"></script>
```

### Глобальные функции
- `reloadAllVideos()` - перезагружает все видео на странице
- `retryVideoLoad(videoId, originalSrc, isIframe)` - перезагружает конкретное видео

## Интеграция с InfopostParser

### Изменения в Swift коде
1. **Упрощена функция `addYouTubeVideo()`** - убрана сложная логика обработки ошибок
2. **Добавлена функция `addUniversalVideoHandler()`** - подключает универсальный скрипт
3. **Удалена функция `generateYouTubeVideoScript()`** - заменена универсальным решением

### Преимущества
- **Единообразие**: одинаковая обработка для всех видео
- **Простота**: меньше кода в Swift
- **Гибкость**: легко добавлять новые типы видео
- **Поддерживаемость**: вся логика в одном JavaScript файле

## Тестирование

Используйте `test_video_handler.html` для тестирования функциональности:
- Рабочее YouTube видео
- Неверный URL для проверки ошибок
- HTML5 видео

## Последние изменения

### v1.6.0 - Критическое исправление jQuery объектов
- **Исправлена ошибка jQuery**: создание нового jQuery объекта из элемента для гарантии корректности
- **Улучшена отладка**: детальная проверка jQuery методов и конструктора объекта
- **Автоматическое восстановление**: попытка создания нового jQuery объекта при ошибке
- **Исправлена генерация ID**: добавлен fallback для пустого parent класса
- **Обработка ошибок**: корректная обработка исключений при инициализации обработчиков
- **Принудительная загрузка**: iframe считается загруженным через 8 секунд если существует
- **Исправлена проблема**: кнопка "Обновить" теперь должна появляться через 10 секунд для не загрузившихся видео

### v1.5.0 - Исправление ошибки jQuery и генерации ID
- **Исправлена ошибка jQuery**: добавлена проверка что element является jQuery объектом
- **Исправлена генерация ID**: добавлен fallback для пустого parent класса
- **Улучшена отладка**: добавлена проверка jQuery методов в логах
- **Обработка ошибок**: корректная обработка исключений при инициализации обработчиков
- **Принудительная загрузка**: iframe считается загруженным через 8 секунд если существует
- **Исправлена проблема**: кнопка "Обновить" теперь должна появляться через 10 секунд для не загрузившихся видео

### v1.4.0 - Критические исправления генерации ID и отладки
- **Исправлена генерация ID**: полная очистка parent класса от недопустимых символов перед генерацией ID
- **Улучшена обработка iframe**: добавлены try-catch блоки для обработки ошибок
- **Расширенная отладка**: подробные логи на каждом этапе обработки iframe
- **Обработка ошибок**: корректная обработка исключений при инициализации обработчиков
- **Принудительная загрузка**: iframe считается загруженным через 8 секунд если существует
- **Исправлена проблема**: кнопка "Обновить" теперь должна появляться через 10 секунд для не загрузившихся видео

### v1.3.0 - Критические исправления для YouTube iframe
- **Исправлена генерация ID**: полная очистка от недопустимых символов в ID видео с дополнительной отладкой
- **Улучшена обработка iframe**: добавлены принудительные проверки через 1, 3 и 8 секунд
- **Расширенная отладка**: промежуточные проверки через 5 секунд и подробная информация о состоянии
- **Принудительная загрузка**: iframe считается загруженным через 8 секунд если существует
- **Обработка CORS**: корректная обработка ошибок при проверке contentDocument
- **Исправлена проблема**: кнопка "Обновить" теперь должна появляться через 10 секунд для не загрузившихся видео

### v1.2.0 - Исправления для YouTube iframe
- **Исправлена генерация ID**: добавлена очистка от недопустимых символов в ID видео
- **Улучшена обработка iframe**: добавлены дополнительные проверки загрузки YouTube iframe
- **Дополнительные таймауты**: проверка через 1 и 3 секунды для медленно загружающихся iframe
- **Обработка CORS**: корректная обработка ошибок при проверке contentDocument
- **Расширенная отладка**: подробная информация о состоянии видео при таймауте
- **Исправлена проблема**: кнопка "Обновить" теперь должна появляться через 10 секунд для не загрузившихся видео

## Совместимость

- jQuery 1.3.1+ (уже подключен в инфопостах)
- Все современные браузеры
- iOS WKWebView
- Android WebView
